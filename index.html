<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedidos Billar - Base de Datos Simulada</title>
<style>
  body { font-family: Arial; background:#f4f4f4; padding:10px; }
  h2 { text-align:center; }
  video { width:100%; max-width:400px; border:2px solid #333; border-radius:8px; }
  select { margin:10px; padding:6px; font-size:1em; }
  table { width:100%; max-width:550px; margin:auto; border-collapse: collapse; }
  th, td { padding:8px; border:1px solid #ccc; text-align:center; }
  input[type=number]{ width:80px; font-size:1.1em; }
  #result { margin-top:10px; text-align:center; font-weight:bold; }
  button { padding:10px 18px; margin:0 4px; font-size:1.2em; border-radius:6px; }
  label { font-weight:bold; }
</style>
</head>
<body>

<h2>üì¶ Esc√°ner de Pedidos - Billar</h2>

<label>Seleccionar c√°mara:</label>
<select id="cameraSelect"></select>
<br>

<video id="video" autoplay></video>
<div id="result">Esperando c√≥digo...</div>
<br>

<label>
  <input type="checkbox" id="mesaCheck"> Activar mesa (+500 por producto)
</label>
<br><br>

<table id="tablaPedidos">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Cantidad</th>
      <th>Precio Unitario</th>
      <th>Subtotal</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<p style="text-align:center;font-weight:bold;">Total general: $<span id="totalGeneral">0</span></p>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
const videoElement = document.getElementById('video');
const resultDiv = document.getElementById('result');
const tabla = document.querySelector('#tablaPedidos tbody');
const totalGeneral = document.getElementById('totalGeneral');
const mesaCheck = document.getElementById('mesaCheck');
const cameraSelect = document.getElementById('cameraSelect');

let pedidos = {}; // key: c√≥digo, value: {nombre, cantidad, precio, basePrecio}

// Simula una "base de datos" de productos
const PRODUCTOS = {
  "900871231234567899260000000826": { nombre:"Cerveza √Åguila 330cc", precio:3300 }
};

// Funci√≥n para actualizar tabla y totales
function actualizarTabla() {
  tabla.innerHTML = "";
  let total = 0;
  for (const code in pedidos) {
    const p = pedidos[code];
    const precioUnitario = mesaCheck.checked ? p.precio + 500 : p.precio;
    const subtotal = p.cantidad * precioUnitario;
    total += subtotal;
    tabla.innerHTML += `
      <tr>
        <td>${p.nombre}</td>
        <td>
          <button onclick="cambiarCantidad('${code}',-1)">-</button>
          <span style="font-size:1.2em;min-width:30px;display:inline-block;">${p.cantidad}</span>
          <button onclick="cambiarCantidad('${code}',1)">+</button>
        </td>
        <td>
          <input type="number" min="0" value="${p.precio}" onchange="cambiarPrecio('${code}',this.value)">
        </td>
        <td>${formatoMoneda(subtotal)}</td>
        <td><button onclick="eliminarProducto('${code}')">‚ùå</button></td>
      </tr>
    `;
  }
  totalGeneral.textContent = formatoMoneda(total);
}

function cambiarCantidad(code, delta){
  pedidos[code].cantidad += delta;
  if(pedidos[code].cantidad < 1) pedidos[code].cantidad = 1;
  actualizarTabla();
// Formato moneda COP
function formatoMoneda(valor) {
  return valor.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
}
}

function cambiarPrecio(code, nuevoPrecio){
  pedidos[code].precio = Number(nuevoPrecio);
  actualizarTabla();
}

function eliminarProducto(code){
  delete pedidos[code];
  actualizarTabla();
}

mesaCheck.addEventListener('change', actualizarTabla);

// Funci√≥n para agregar producto por c√≥digo escaneado
function agregarProductoPorCodigo(code){
  if(PRODUCTOS[code]){
    if(pedidos[code]){
      pedidos[code].cantidad += 1;
    } else {
      pedidos[code] = { ...PRODUCTOS[code], cantidad:1, basePrecio:PRODUCTOS[code].precio };
    }
    actualizarTabla();
  } else {
    console.warn("Producto no encontrado en base de datos: ", code);
  }
}

// Listar c√°maras y permitir selecci√≥n
codeReader.listVideoInputDevices().then(videoInputDevices => {
  videoInputDevices.forEach((device, index)=>{
    const option = document.createElement('option');
    option.text = device.label || `C√°mara ${index+1}`;
    option.value = device.deviceId;
    cameraSelect.appendChild(option);
  });

  // Seleccionar la c√°mara trasera por defecto
  let backCamera = videoInputDevices.find(cam=>/back|rear|environment/i.test(cam.label)) || videoInputDevices[0];
  cameraSelect.value = backCamera.deviceId;
  iniciarEscaneo(backCamera.deviceId);
});

// Cambiar de c√°mara
cameraSelect.onchange = () => {
  iniciarEscaneo(cameraSelect.value);
}

// Iniciar escaneo
function iniciarEscaneo(deviceId){
  codeReader.reset();
  codeReader.decodeFromVideoDevice(deviceId, videoElement, (result, err)=>{
    if(result){
      const code = result.getText();
      resultDiv.textContent = "‚úÖ C√≥digo detectado: " + code;
      agregarProductoPorCodigo(code); // buscar autom√°ticamente y agregar
    }
    if(err && !(err instanceof ZXing.NotFoundException)){
      console.warn(err);
    }
  }, { constraints:{ facingMode:"environment", width:{ideal:1920}, height:{ideal:1080} } });
}
</script>

</body>
</html>
