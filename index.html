<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedidos Billar</title>
<style>
  body { font-family: Arial; background:#f4f4f4; padding:10px; }
  h2 { text-align:center; }
  video { width:100%; max-width:400px; border:2px solid #333; border-radius:8px; }
  table { width:100%; max-width:400px; margin:auto; border-collapse: collapse; }
  th, td { padding:8px; border:1px solid #ccc; text-align:center; }
  input[type=number]{ width:50px; }
  #result { margin-top:10px; text-align:center; font-weight:bold; }
</style>
</head>
<body>

<h2>üì¶ Esc√°ner de Pedidos - Billar</h2>
<video id="video" autoplay></video>
<div id="result">Esperando c√≥digo...</div>
<br>

<label>
  <input type="checkbox" id="mesaCheck"> Activar mesa (+500 por producto)
</label>
<br><br>

<table id="tablaPedidos">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Cantidad</th>
      <th>Precio Unitario</th>
      <th>Total</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<p style="text-align:center;font-weight:bold;">Total general: $<span id="totalGeneral">0</span></p>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
const videoElement = document.getElementById('video');
const resultDiv = document.getElementById('result');
const tabla = document.querySelector('#tablaPedidos tbody');
const totalGeneral = document.getElementById('totalGeneral');
const mesaCheck = document.getElementById('mesaCheck');

let pedidos = {}; // key: c√≥digo, value: objeto {nombre, cantidad, precio}

const PRODUCTOS = {
  "900871231234567899260000000826": { nombre:"Cerveza √Åguila 330cc", precio:3300 }
};

function actualizarTabla() {
  tabla.innerHTML = "";
  let total = 0;
  for (const code in pedidos) {
    const p = pedidos[code];
    const precioUnitario = p.precio + (mesaCheck.checked ? 500 : 0);
    const totalProd = p.cantidad * precioUnitario;
    total += totalProd;
    tabla.innerHTML += `
      <tr>
        <td>${p.nombre}</td>
        <td>
          <button onclick="cambiarCantidad('${code}',-1)">-</button>
          ${p.cantidad}
          <button onclick="cambiarCantidad('${code}',1)">+</button>
        </td>
        <td>${precioUnitario}</td>
        <td>${totalProd}</td>
        <td><button onclick="eliminarProducto('${code}')">‚ùå</button></td>
      </tr>
    `;
  }
  totalGeneral.textContent = total;
}

function cambiarCantidad(code, delta){
  pedidos[code].cantidad += delta;
  if(pedidos[code].cantidad < 0) pedidos[code].cantidad = 0;
  actualizarTabla();
}

function eliminarProducto(code){
  delete pedidos[code];
  actualizarTabla();
}

mesaCheck.addEventListener('change', actualizarTabla);

function agregarProducto(code){
  if(PRODUCTOS[code]){
    if(pedidos[code]){
      pedidos[code].cantidad += 1;
    } else {
      pedidos[code] = { ...PRODUCTOS[code], cantidad:1 };
    }
    actualizarTabla();
  }
}

// Configuraci√≥n de la c√°mara
codeReader.listVideoInputDevices().then(videoInputDevices => {
  let backCamera = videoInputDevices.find(cam=>/back|rear|environment/i.test(cam.label)) || videoInputDevices[0];
  codeReader.decodeFromVideoDevice(backCamera.deviceId, videoElement, (result, err)=>{
    if(result){
      const code = result.getText();
      resultDiv.textContent = "‚úÖ C√≥digo detectado: " + code;
      agregarProducto(code);
    }
    if(err && !(err instanceof ZXing.NotFoundException)){
      console.warn(err);
    }
  }, { constraints:{ facingMode:"environment", width:{ideal:1920}, height:{ideal:1080} } });
});
</script>

</body>
</html>
