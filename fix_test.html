<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Rápido - Fix Utils Error</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">🧪 Test Fix: Utils Error</h1>
        
        <div class="bg-white rounded-lg p-6 shadow mb-6">
            <h2 class="text-xl font-bold mb-4">Estado del Fix</h2>
            <div id="fixStatus" class="space-y-2">
                <div>✅ Import de Utils agregado a DataService</div>
                <div>🔧 Servidor reiniciado</div>
                <div id="testResult" class="text-gray-500">⏳ Esperando test...</div>
            </div>
        </div>

        <div class="flex gap-4 justify-center mb-6">
            <button onclick="testRondaCreation()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                🍽️ Probar Crear Ronda
            </button>
            <button onclick="openMainApp()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg">
                📱 Ir al Sistema Principal
            </button>
        </div>

        <div id="logOutput" class="bg-black text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto">
            <div>Sistema de test iniciado...</div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : '🔧';
            logDiv.innerHTML += `<div>[${timestamp}] ${prefix} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testRondaCreation() {
            log('Iniciando test de creación de rondas...');
            
            try {
                // Importar módulos
                log('Importando DataService...');
                const { DataService } = await import('./frontend/js/services/data-service.js');
                
                log('Importando ModalManager...');
                const { ModalManager } = await import('./frontend/js/modules/modal-manager.js');
                
                log('Importando RondaManager...');
                const { RondaManager } = await import('./frontend/js/modules/ronda-manager.js');
                
                // Crear instancias
                log('Creando instancias...');
                const dataService = new DataService();
                await dataService.init();
                
                const modalManager = new ModalManager(dataService);
                modalManager.init();
                
                const rondaManager = new RondaManager(dataService, modalManager);
                await rondaManager.init();
                
                log('Todas las instancias creadas correctamente', 'success');
                
                // Test básico de saveRonda
                log('Probando saveRonda...');
                const testRonda = {
                    id: 'test_ronda_' + Date.now(),
                    numero_ronda: 1,
                    productos: [
                        {
                            nombre: 'Producto Test',
                            precio_unitario: 5000,
                            cantidad: 2
                        }
                    ],
                    total: 10000,
                    estado: 'guardada',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    pagos: []
                };
                
                const result = await dataService.saveRonda(testRonda, 'test_pedido');
                log('saveRonda ejecutado sin errores ✅', 'success');
                log(`Resultado: ${JSON.stringify(result.id)}`);
                
                // Actualizar estado
                document.getElementById('testResult').innerHTML = '✅ Test exitoso - Error de Utils solucionado';
                document.getElementById('testResult').className = 'text-green-600 font-bold';
                
                log('🎉 TEST EXITOSO - El error de Utils ha sido solucionado', 'success');
                
            } catch (error) {
                log(`Error en el test: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
                
                document.getElementById('testResult').innerHTML = '❌ Test falló - ' + error.message;
                document.getElementById('testResult').className = 'text-red-600 font-bold';
                
                if (error.message.includes('Utils is not defined')) {
                    log('❌ El error de Utils persiste. Verificando imports...', 'error');
                } else {
                    log('✅ Error de Utils solucionado, pero hay otro problema', 'success');
                }
            }
        }

        function openMainApp() {
            window.location.href = 'app.html';
        }

        // Auto-ejecutar test al cargar
        window.addEventListener('load', () => {
            log('Página cargada. Haz clic en "Probar Crear Ronda" para verificar el fix.');
        });
    </script>
</body>
</html>