<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Pedidos Pendientes - Barcode Terkkos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üçΩÔ∏è Barcode Terkkos</h1>
            <h2 class="text-xl text-gray-600">Consulta de Pedidos Pendientes desde Base de Datos</h2>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="flex justify-center gap-4 mb-6">
            <button id="btnConsultar" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-colors">
                üîç Consultar BD
            </button>
            <button id="btnLimpiar" 
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-colors">
                üóëÔ∏è Limpiar
            </button>
            <a href="app.html" 
               class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-colors">
                üì± Ir al Sistema
            </a>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="hidden text-center py-8">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Consultando base de datos...</p>
        </div>

        <!-- Error container -->
        <div id="errorContainer" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            <strong class="font-bold">Error: </strong>
            <span id="errorMessage"></span>
        </div>

        <!-- Estad√≠sticas -->
        <div id="estadisticas" class="hidden grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-blue-500 text-white p-4 rounded-lg text-center">
                <div class="text-2xl font-bold" id="statTotalPedidos">0</div>
                <div class="text-sm opacity-90">Pedidos Activos</div>
            </div>
            <div class="bg-red-500 text-white p-4 rounded-lg text-center">
                <div class="text-2xl font-bold" id="statSaldoPendiente">$0</div>
                <div class="text-sm opacity-90">Saldo Pendiente</div>
            </div>
            <div class="bg-green-500 text-white p-4 rounded-lg text-center">
                <div class="text-2xl font-bold" id="statTotalPagado">$0</div>
                <div class="text-sm opacity-90">Total Pagado</div>
            </div>
            <div class="bg-purple-500 text-white p-4 rounded-lg text-center">
                <div class="text-2xl font-bold" id="statPromedio">$0</div>
                <div class="text-sm opacity-90">Promedio/Pedido</div>
            </div>
            <div class="bg-orange-500 text-white p-4 rounded-lg text-center">
                <div class="text-2xl font-bold" id="statMesasActivas">0</div>
                <div class="text-sm opacity-90">Mesas Activas</div>
            </div>
        </div>

        <!-- Resultados -->
        <div id="resultados" class="hidden">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">üìã Pedidos Pendientes</h3>
            <div id="pedidosContainer" class="space-y-4"></div>
        </div>

        <!-- Info -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h4 class="font-bold text-blue-800 mb-2">‚ÑπÔ∏è Informaci√≥n</h4>
            <ul class="text-blue-700 space-y-1 text-sm">
                <li>‚Ä¢ Esta p√°gina consulta directamente la base de datos MySQL</li>
                <li>‚Ä¢ Muestra todos los pedidos con estado "activo"</li>
                <li>‚Ä¢ Incluye informaci√≥n de rondas, pagos y mesas alquiladas</li>
                <li>‚Ä¢ Los datos se obtienen en tiempo real desde la BD</li>
            </ul>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const btnConsultar = document.getElementById('btnConsultar');
        const btnLimpiar = document.getElementById('btnLimpiar');
        const loading = document.getElementById('loading');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const estadisticas = document.getElementById('estadisticas');
        const resultados = document.getElementById('resultados');
        const pedidosContainer = document.getElementById('pedidosContainer');

        // Elementos de estad√≠sticas
        const statTotalPedidos = document.getElementById('statTotalPedidos');
        const statSaldoPendiente = document.getElementById('statSaldoPendiente');
        const statTotalPagado = document.getElementById('statTotalPagado');
        const statPromedio = document.getElementById('statPromedio');
        const statMesasActivas = document.getElementById('statMesasActivas');

        // Event listeners
        btnConsultar.addEventListener('click', consultarPedidos);
        btnLimpiar.addEventListener('click', limpiarResultados);

        // Funci√≥n para consultar pedidos
        async function consultarPedidos() {
            mostrarLoading(true);
            ocultarError();
            
            try {
                const response = await fetch('api/get_pedidos_pendientes.php');
                const data = await response.json();
                
                if (data.success) {
                    mostrarResultados(data);
                } else {
                    mostrarError(data.error + ': ' + data.message);
                }
            } catch (error) {
                mostrarError('Error de conexi√≥n: ' + error.message);
                console.error('Error:', error);
            } finally {
                mostrarLoading(false);
            }
        }

        // Mostrar resultados
        function mostrarResultados(data) {
            // Mostrar estad√≠sticas
            statTotalPedidos.textContent = data.estadisticas.total_pedidos_activos;
            statSaldoPendiente.textContent = formatoCOP(data.estadisticas.total_saldo_pendiente);
            statTotalPagado.textContent = formatoCOP(data.estadisticas.total_pagado_hoy);
            statPromedio.textContent = formatoCOP(data.estadisticas.promedio_por_pedido);
            statMesasActivas.textContent = data.estadisticas.mesas_activas;
            
            estadisticas.classList.remove('hidden');

            // Mostrar pedidos
            pedidosContainer.innerHTML = '';
            
            if (data.pedidos.length === 0) {
                pedidosContainer.innerHTML = `
                    <div class="text-center py-8 bg-white rounded-lg shadow">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-xl font-semibold mb-2">¬°No hay pedidos pendientes!</h3>
                        <p class="text-gray-600">Todos los pedidos est√°n pagados o no hay pedidos activos.</p>
                    </div>
                `;
            } else {
                data.pedidos.forEach(pedido => {
                    const pedidoElement = crearElementoPedido(pedido);
                    pedidosContainer.appendChild(pedidoElement);
                });
            }
            
            resultados.classList.remove('hidden');
        }

        // Crear elemento HTML para un pedido
        function crearElementoPedido(pedido) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-6';
            
            const estadoPago = getEstadoPagoClass(pedido.estado_pago);
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="text-xl font-bold text-gray-800">${pedido.numero_pedido}</h4>
                        <p class="text-gray-600">üë§ ${pedido.nombre_cliente}</p>
                        <p class="text-sm text-gray-500">üìÖ ${formatearFecha(pedido.created_at)}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold ${estadoPago.color}">${formatoCOP(pedido.saldo_pendiente)}</div>
                        <div class="text-sm ${estadoPago.bgClass} ${estadoPago.textClass} px-2 py-1 rounded">
                            ${estadoPago.texto}
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-semibold text-gray-700">üí∞ Total Pedido</div>
                        <div class="text-lg font-bold">${formatoCOP(pedido.total_pedido)}</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-semibold text-gray-700">‚úÖ Total Pagado</div>
                        <div class="text-lg font-bold text-green-600">${formatoCOP(pedido.total_pagado)}</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-semibold text-gray-700">üçΩÔ∏è Rondas</div>
                        <div class="text-lg font-bold">${pedido.total_rondas} (${pedido.rondas_pagadas} pagadas)</div>
                    </div>
                </div>
                
                ${pedido.tiene_mesa ? `
                    <div class="bg-purple-50 border border-purple-200 p-3 rounded mb-4">
                        <div class="font-semibold text-purple-800">ü™ë Mesa ${pedido.numero_mesa}</div>
                        <div class="text-sm text-purple-600">
                            Estado: ${pedido.mesa_activa ? 'üü¢ Activa' : 'üî¥ Terminada'} | 
                            Tiempo: ${pedido.tiempo_mesa_minutos} min | 
                            Costo: ${formatoCOP(pedido.mesa_costo)}
                        </div>
                    </div>
                ` : ''}
                
                ${pedido.notas ? `
                    <div class="bg-yellow-50 border border-yellow-200 p-3 rounded">
                        <div class="font-semibold text-yellow-800">üìù Notas</div>
                        <div class="text-yellow-700">${pedido.notas}</div>
                    </div>
                ` : ''}
            `;
            
            return div;
        }

        // Obtener clase CSS seg√∫n estado de pago
        function getEstadoPagoClass(estadoPago) {
            switch (estadoPago) {
                case 'pagado_completo':
                    return {
                        color: 'text-green-600',
                        bgClass: 'bg-green-100',
                        textClass: 'text-green-800',
                        texto: '‚úÖ Pagado Completo'
                    };
                case 'pago_parcial':
                    return {
                        color: 'text-orange-600',
                        bgClass: 'bg-orange-100',
                        textClass: 'text-orange-800',
                        texto: '‚ö†Ô∏è Pago Parcial'
                    };
                case 'sin_pagar':
                    return {
                        color: 'text-red-600',
                        bgClass: 'bg-red-100',
                        textClass: 'text-red-800',
                        texto: '‚ùå Sin Pagar'
                    };
                default:
                    return {
                        color: 'text-gray-600',
                        bgClass: 'bg-gray-100',
                        textClass: 'text-gray-800',
                        texto: '‚ùì Desconocido'
                    };
            }
        }

        // Formatear moneda
        function formatoCOP(valor) {
            if (valor === null || valor === undefined || isNaN(valor)) {
                return '$0';
            }
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                maximumFractionDigits: 0
            }).format(valor);
        }

        // Formatear fecha
        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleString('es-CO', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Mostrar loading
        function mostrarLoading(mostrar) {
            if (mostrar) {
                loading.classList.remove('hidden');
                btnConsultar.disabled = true;
                btnConsultar.innerHTML = '‚è≥ Consultando...';
            } else {
                loading.classList.add('hidden');
                btnConsultar.disabled = false;
                btnConsultar.innerHTML = 'üîç Consultar BD';
            }
        }

        // Mostrar error
        function mostrarError(mensaje) {
            errorMessage.textContent = mensaje;
            errorContainer.classList.remove('hidden');
        }

        // Ocultar error
        function ocultarError() {
            errorContainer.classList.add('hidden');
        }

        // Limpiar resultados
        function limpiarResultados() {
            estadisticas.classList.add('hidden');
            resultados.classList.add('hidden');
            ocultarError();
            pedidosContainer.innerHTML = '';
        }

        // Consultar autom√°ticamente al cargar la p√°gina
        // window.addEventListener('load', consultarPedidos);
    </script>
</body>
</html>