<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Terkkos - Test (Sin Cache)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .log { background: white; border-radius: 8px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .error { background: #fee; border-left: 4px solid #f00; }
        .success { background: #efe; border-left: 4px solid #0a0; }
        .warning { background: #ffc; border-left: 4px solid #fa0; }
        .reload-btn { 
            background: #007cba; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px 5px;
        }
        .reload-btn:hover { background: #005a8b; }
    </style>
</head>
<body>
    <h1>üîß Barcode Terkkos - Diagn√≥stico (Sin Cache)</h1>
    
    <div style="margin-bottom: 20px;">
        <button class="reload-btn" onclick="location.reload(true)">üîÑ Recargar (Forzar)</button>
        <button class="reload-btn" onclick="clearCacheAndReload()">üóëÔ∏è Limpiar Cache y Recargar</button>
        <button class="reload-btn" onclick="runTest()">üß™ Ejecutar Test</button>
    </div>
    
    <div id="logs"></div>
    
    <script>
        const logContainer = document.getElementById('logs');
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logContainer.appendChild(div);
            console.log(message);
        }
        
        function clearCacheAndReload() {
            // Limpiar localStorage
            localStorage.clear();
            
            // Limpiar sessionStorage
            sessionStorage.clear();
            
            // Recargar sin cache
            location.reload(true);
        }
        
        async function runTest() {
            // Limpiar logs anteriores
            logContainer.innerHTML = '';
            
            try {
                addLog('üöÄ Iniciando diagn√≥stico del sistema (sin cache)...', 'info');
                
                // Generar timestamp para evitar cache
                const timestamp = Date.now();
                
                // Test 1: Cargar Utils
                addLog('üìÅ Cargando Utils...', 'info');
                const utilsModule = await import(`./frontend/js/utils/utils.js?v=${timestamp}`);
                const { Utils } = utilsModule;
                addLog('‚úÖ Utils cargado correctamente', 'success');
                
                // Test 2: Cargar DataService
                addLog('üìä Cargando DataService...', 'info');
                const dataServiceModule = await import(`./frontend/js/services/data-service.js?v=${timestamp}`);
                const { DataService } = dataServiceModule;
                addLog('‚úÖ DataService cargado correctamente', 'success');
                
                // Test 3: Crear instancia de DataService
                addLog('üîß Creando instancia de DataService...', 'info');
                const dataService = new DataService();
                addLog('‚úÖ Instancia de DataService creada', 'success');
                addLog(`üîç Propiedades de dataService: ${Object.getOwnPropertyNames(dataService).join(', ')}`, 'info');
                addLog(`üîç M√©todos de DataService: ${Object.getOwnPropertyNames(Object.getPrototypeOf(dataService)).join(', ')}`, 'info');
                
                // Test 4: Verificar m√©todo init
                addLog('üîç Verificando m√©todo init()...', 'info');
                if (typeof dataService.init === 'function') {
                    addLog('‚úÖ M√©todo init() encontrado', 'success');
                } else {
                    addLog('‚ùå M√©todo init() NO encontrado', 'error');
                    addLog(`‚ùì Tipo de init: ${typeof dataService.init}`, 'error');
                    return;
                }
                
                // Test 5: Ejecutar init
                addLog('‚ö° Ejecutando dataService.init()...', 'info');
                await dataService.init();
                addLog('‚úÖ DataService.init() ejecutado correctamente', 'success');
                
                // Test 6: Cargar ModalManager
                addLog('ü™ü Cargando ModalManager...', 'info');
                const modalModule = await import(`./frontend/js/modules/modal-manager.js?v=${timestamp}`);
                const { ModalManager } = modalModule;
                const modalManager = new ModalManager(dataService);
                modalManager.init();
                addLog('‚úÖ ModalManager inicializado', 'success');
                
                // Test 7: Cargar todos los managers
                addLog('üìã Cargando PedidoManager...', 'info');
                const pedidoModule = await import(`./frontend/js/modules/pedido-manager.js?v=${timestamp}`);
                const { PedidoManager } = pedidoModule;
                addLog('‚úÖ PedidoManager cargado', 'success');
                
                addLog('üçΩÔ∏è Cargando RondaManager...', 'info');
                const rondaModule = await import(`./frontend/js/modules/ronda-manager.js?v=${timestamp}`);
                const { RondaManager } = rondaModule;
                addLog('‚úÖ RondaManager cargado', 'success');
                
                addLog('üí≥ Cargando PagoManager...', 'info');
                const pagoModule = await import(`./frontend/js/modules/pago-manager.js?v=${timestamp}`);
                const { PagoManager } = pagoModule;
                addLog('‚úÖ PagoManager cargado', 'success');
                
                addLog('ü™ë Cargando MesaManager...', 'info');
                const mesaModule = await import(`./frontend/js/modules/mesa-manager.js?v=${timestamp}`);
                const { MesaManager } = mesaModule;
                addLog('‚úÖ MesaManager cargado', 'success');
                
                addLog('üéâ ¬°Todos los m√≥dulos se cargaron correctamente!', 'success');
                addLog('‚úÖ El sistema est√° listo para funcionar', 'success');
                
                // Test 8: Probar creaci√≥n completa del sistema
                addLog('üöÄ Probando inicializaci√≥n completa del sistema...', 'info');
                const mainModule = await import(`./frontend/js/main.js?v=${timestamp}`);
                addLog('‚úÖ main.js cargado correctamente', 'success');
                
                addLog('üéä DIAGN√ìSTICO COMPLETADO EXITOSAMENTE', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error en el diagn√≥stico: ${error.message}`, 'error');
                addLog(`üìö Stack trace: ${error.stack}`, 'error');
            }
        }
        
        // Auto-ejecutar test al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            runTest();
        });
    </script>
</body>
</html>