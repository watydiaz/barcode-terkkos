<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Cliente</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="w-full bg-blue-600 py-6 shadow fixed top-0 left-0 z-40">
    <h1 class="text-4xl font-bold text-white text-center">Gestión de Pedidos</h1>
  </div>
  <div class="w-full px-0 pt-24">
    <div id="acordeonesPedidos" class="space-y-4 w-full"></div>
  </div>

  <!-- Botón flotante para crear pedido -->
  <button id="btnNuevoPedido" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center text-3xl z-50">+</button>

  <script>
  // Agregar fila a la tabla tipo Excel (debe estar antes de abrirModalRonda)
  window.agregarFilaExcel = function agregarFilaExcel() {
    const tbody = modal.querySelector('tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-2 py-1"><input type="text" class="w-32 border rounded px-1 py-0.5" required></td>
      <td class="px-2 py-1"><input type="number" class="w-20 border rounded px-1 py-0.5" min="0" required></td>
      <td class="px-2 py-1"><input type="number" class="w-12 border rounded px-1 py-0.5 text-center" min="1" value="1" required></td>
      <td class="px-2 py-1 subtotal">$0</td>
      <td><button type="button" class="text-red-600 font-bold" onclick="this.closest('tr').remove()">✕</button></td>
    `;
    tbody.appendChild(tr);
  }
  // Modal global para crear ronda
  let modal = document.createElement('div');
  modal.id = 'modalRonda';
  modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl">
      <h3 class="text-xl font-bold mb-4">Crear ronda</h3>
      <div class="overflow-x-auto">
        <table id="tablaExcel" class="min-w-full text-sm text-left border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1">Producto</th>
              <th class="px-2 py-1">Precio Unitario</th>
              <th class="px-2 py-1">Cantidad</th>
              <th class="px-2 py-1">Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button id="btnAgregarFila" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Agregar producto</button>
      <div class="flex justify-end space-x-2 mt-6">
        <button type="button" id="btnCancelarModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cancelar</button>
        <button type="button" id="btnGuardarRondaModal" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Guardar ronda</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  // Asignar funcionalidad al botón de agregar producto
  document.getElementById('btnAgregarFila').onclick = agregarFilaExcel;

  // Actualizar subtotal en la tabla tipo Excel (modal) al cambiar precio o cantidad
  modal.addEventListener('input', function(e) {
    if (e.target && (e.target.matches('input[type="number"]') || e.target.matches('input[type="text"]'))) {
      const tr = e.target.closest('tr');
      if (!tr) return;
      const precioInput = tr.children[1].querySelector('input');
      const cantidadInput = tr.children[2].querySelector('input');
      if (!precioInput || !cantidadInput) return;
      const precio = parseFloat(precioInput.value) || 0;
      const cantidad = parseInt(cantidadInput.value) || 1;
      tr.querySelector('.subtotal').textContent = (precio * cantidad).toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
    }
  });

  // Botón cancelar cierra el modal
  document.getElementById('btnCancelarModal').onclick = function() {
    modal.classList.add('hidden');
  };

  // Funcionalidad para guardar la ronda y actualizar tabs
  document.getElementById('btnGuardarRondaModal').onclick = function() {
    // Esta función queda vacía, la lógica está en abrirModalRonda para evitar duplicidad
    return;
  };
  // Lógica para abrir el modal desde el acordeón correcto
  window.abrirModalRonda = function(btn) {
    if (!modal) return;
    modal.classList.remove('hidden');
    // Guardar referencia al acordeón actual usando el id único
    const acordeon = btn.closest('.border.rounded.shadow');
    if (acordeon && acordeon.id) {
      modal.dataset.targetAcordeon = acordeon.id;
    } else {
      modal.dataset.targetAcordeon = '';
    }
    // Limpiar tabla
    const tbody = modal.querySelector('tbody');
    tbody.innerHTML = '';
    agregarFilaExcel();
    // Reasignar eventos para evitar bloqueos
    document.getElementById('btnAgregarFila').onclick = agregarFilaExcel;
    document.getElementById('btnCancelarModal').onclick = function() {
      modal.classList.add('hidden');
    };
    document.getElementById('btnGuardarRondaModal').onclick = function() {
      const filas = Array.from(tbody.querySelectorAll('tr'));
      if (filas.length === 0) {
        alert('Agrega al menos un producto antes de guardar la ronda.');
        return;
      }
      let acordeonDestino = null;
      if (modal.dataset.targetAcordeon) {
        acordeonDestino = document.getElementById(modal.dataset.targetAcordeon);
      }
      if (!acordeonDestino) return;
      let total = 0;
      let productos = [];
      filas.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const nombre = tds[0].querySelector('input').value;
        const precio = parseFloat(tds[1].querySelector('input').value) || 0;
        const cantidad = parseInt(tds[2].querySelector('input').value) || 1;
        const subtotal = precio * cantidad;
        total += subtotal;
        productos.push({nombre, cantidad, precio, subtotal});
      });
      let rondas = [];
      try { rondas = JSON.parse(acordeonDestino.dataset.rondas || '[]'); } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      rondas.push({productos, total, responsable: ''});
      acordeonDestino.dataset.rondas = JSON.stringify(rondas);
      renderizarRondas(acordeonDestino);
      // Actualizar la cápsula de total
      const pill = acordeonDestino.querySelector('.total-pill');
      let totalAcumulado = 0;
      rondas.forEach(r => { totalAcumulado += r.total || 0; });
      if (pill) {
        pill.textContent = totalAcumulado.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      }
      modal.classList.add('hidden');
    };
    // Subtotal en el modal
    modal.addEventListener('input', function(e) {
      if (e.target && (e.target.matches('input[type="number"]') || e.target.matches('input[type="text"]'))) {
        const tr = e.target.closest('tr');
        if (!tr) return;
        const precioInput = tr.children[1].querySelector('input');
        const cantidadInput = tr.children[2].querySelector('input');
        if (!precioInput || !cantidadInput) return;
        const precio = parseFloat(precioInput.value) || 0;
        const cantidad = parseInt(cantidadInput.value) || 1;
        tr.querySelector('.subtotal').textContent = (precio * cantidad).toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      }
    });
  };

    // Renderiza las rondas como tabs y muestra totales
    function renderizarRondas(acordeon) {
      const tabsDiv = acordeon.querySelector('.tabs-rondas');
      const contenidoDiv = acordeon.querySelector('.contenido-ronda');
      const totalAcumuladoDiv = acordeon.querySelector('.total-acumulado');
      let rondas = [];
       try {
         rondas = JSON.parse(acordeon.dataset.rondas || '[]');
       } catch (e) {
         console.error('Error parsing rondas:', e);
       }
      if (!Array.isArray(rondas)) rondas = [];
      tabsDiv.innerHTML = '';
      contenidoDiv.innerHTML = '';
      let totalAcumulado = 0;
      // Determinar ronda activa (por defecto la 0)
      let rondaActiva = acordeon._rondaActiva ?? 0;
      if (rondaActiva >= rondas.length) rondaActiva = 0;
      // Paleta de colores pasteles suaves
      const pastelTabs = [
        {bg: 'bg-blue-200', text: 'text-blue-900', border: 'border-blue-300', info: 'bg-blue-50'},
        {bg: 'bg-green-200', text: 'text-green-900', border: 'border-green-300', info: 'bg-green-50'},
        {bg: 'bg-pink-200', text: 'text-pink-900', border: 'border-pink-300', info: 'bg-pink-50'},
        {bg: 'bg-yellow-200', text: 'text-yellow-900', border: 'border-yellow-300', info: 'bg-yellow-50'},
        {bg: 'bg-purple-200', text: 'text-purple-900', border: 'border-purple-300', info: 'bg-purple-50'},
        {bg: 'bg-teal-200', text: 'text-teal-900', border: 'border-teal-300', info: 'bg-teal-50'},
        {bg: 'bg-orange-200', text: 'text-orange-900', border: 'border-orange-300', info: 'bg-orange-50'}
      ];
      rondas.forEach((ronda, idx) => {
        totalAcumulado += ronda.total || 0;
        const color = pastelTabs[idx % pastelTabs.length];
        const isActive = idx === rondaActiva;
        const tabBtn = document.createElement('button');
        tabBtn.className = `px-4 py-2 rounded-t font-semibold border-b-2 ${isActive ? color.bg + ' ' + color.text + ' ' + color.border + ' shadow' : 'bg-gray-200 hover:bg-gray-300 border-transparent text-gray-800'}`;
        tabBtn.textContent = `Ronda #${idx+1}`;
        tabBtn.onclick = () => {
          acordeon._rondaActiva = idx;
          renderizarRondas(acordeon);
        };
        tabBtn.dataset.infoColor = color.info;
        tabsDiv.appendChild(tabBtn);
      });
      if (rondas.length > 0) {
        mostrarRonda(acordeon, rondaActiva);
        totalAcumuladoDiv.style.display = 'block';
      } else {
        // Si no hay rondas, esto no debería ocurrir porque el acordeón se elimina
        totalAcumuladoDiv.style.display = 'none';
        contenidoDiv.innerHTML = '';
      }
      
      // Actualizar el total en el header (píldora azul)
      const totalPill = acordeon.querySelector('.total-pill');
      if (totalPill) {
        totalPill.textContent = totalAcumulado > 0 ? '$' + totalAcumulado.toLocaleString('es-CO') : '$0';
      }
      
      totalAcumuladoDiv.textContent = 'Total del pedido: ' + (totalAcumulado > 0 ? totalAcumulado.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }) : '$ 0');
    }

    // Muestra el contenido de una ronda seleccionada
    function mostrarRonda(acordeon, idx) {
      const contenidoDiv = acordeon.querySelector('.contenido-ronda');
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      const ronda = rondas[idx];
      if (!ronda) return;
      // Obtener color de fondo de la tab activa
      const tabsDiv = acordeon.querySelector('.tabs-rondas');
      let bgColor = 'bg-blue-200';
      if (tabsDiv && tabsDiv.children[idx]) {
        // Buscar la clase bg-* de la pestaña activa
        const classList = Array.from(tabsDiv.children[idx].classList);
        const bgClass = classList.find(c => c.startsWith('bg-'));
        if (bgClass) bgColor = bgClass;
      }
      let html = `<div class='mb-2 flex flex-wrap gap-4 items-center'>`;
      html += `<span class='font-bold text-green-700'>Ronda #${idx+1} <span class='text-blue-700'>(${ronda.total.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })})</span></span>`;
      html += `</div>`;
      // Tabla de productos y responsables con fondo igual a la pestaña
      html += `<div class='rounded-lg p-4 mt-2 ${bgColor}'>`;
      html += `<div class='overflow-x-auto'><table class='min-w-full text-sm text-left border'>`;
      html += `<thead class='bg-gray-100'><tr><th class='px-2 py-1'>Producto</th><th class='px-2 py-1'>Cantidad</th><th class='px-2 py-1'>Precio Unitario</th><th class='px-2 py-1'>Subtotal</th><th class='px-2 py-1'>Acciones</th></tr></thead><tbody>`;
      (ronda.productos || []).forEach((p, prodIdx) => {
        html += `<tr data-producto-idx="${prodIdx}">`;
        html += `<td class='px-2 py-1'><input type="text" class="w-full border rounded px-1 py-0.5 producto-nombre" value="${p.nombre}" onchange="actualizarProducto('${acordeon.id}', ${idx}, ${prodIdx})"></td>`;
        html += `<td class='px-2 py-1'><input type="number" class="w-16 border rounded px-1 py-0.5 producto-cantidad" min="1" value="${p.cantidad}" onchange="actualizarProducto('${acordeon.id}', ${idx}, ${prodIdx})"></td>`;
        html += `<td class='px-2 py-1'><input type="number" class="w-20 border rounded px-1 py-0.5 producto-precio" min="0" value="${p.precio}" onchange="actualizarProducto('${acordeon.id}', ${idx}, ${prodIdx})"></td>`;
        html += `<td class='px-2 py-1 producto-subtotal'>${p.subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td>`;
        html += `<td class='px-2 py-1'>`;
        html += `<div class="flex gap-1">`;
        html += `<button type="button" class="text-blue-600 font-bold hover:bg-blue-100 px-1 py-1 rounded text-xs" onclick="cambiarProducto('${acordeon.id}', ${idx}, ${prodIdx})" title="Cambiar producto">🔄</button>`;
        html += `<button type="button" class="text-orange-600 font-bold hover:bg-orange-100 px-1 py-1 rounded text-xs" onclick="devolverProducto('${acordeon.id}', ${idx}, ${prodIdx})" title="Devolver producto (descuento)">↩️</button>`;
        html += `<button type="button" class="text-red-600 font-bold hover:bg-red-100 px-1 py-1 rounded text-xs" onclick="eliminarProducto('${acordeon.id}', ${idx}, ${prodIdx})" title="Eliminar producto">✕</button>`;
        html += `</div>`;
        html += `</td>`;
        html += `</tr>`;
      });
      html += `</tbody></table></div>`;
      html += `<div class="flex flex-wrap gap-2 mt-2">`;
      html += `<button type="button" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm" onclick="agregarProductoRonda('${acordeon.id}', ${idx})">+ Agregar producto</button>`;
      // Mostrar botón duplicar solo en la última ronda
      if (idx === rondas.length - 1) {
        html += `<button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm" onclick="duplicarRonda('${acordeon.id}', ${idx})" title="Duplicar esta ronda">📋 Duplicar ronda</button>`;
      }
      html += `</div>`;
      
      // Sección de cálculo dividido y pago
      html += `<div class="mt-4 p-3 bg-gray-50 rounded border">`;
      html += `<div class="flex flex-wrap items-center gap-2 mb-2">`;
      html += `<span class="font-semibold">Dividir saldo entre:</span>`;
      html += `<input type="number" id="dividir-${acordeon.id}-${idx}" class="w-16 border rounded px-2 py-1 text-center" min="1" value="1" onchange="calcularDivision('${acordeon.id}', ${idx})">`;
      html += `<span class="font-semibold">personas =</span>`;
      // Calcular saldo pendiente para mostrar inicialmente
      const pagosIniciales = ronda.pagos || [];
      let totalPagadoInicial = 0;
      pagosIniciales.forEach(pago => totalPagadoInicial += pago.monto);
      const saldoPendiente = ronda.total - totalPagadoInicial;
      if (saldoPendiente <= 0) {
        html += `<span id="resultado-${acordeon.id}-${idx}" class="font-bold text-green-600">✅ PAGADO</span>`;
      } else {
        html += `<span id="resultado-${acordeon.id}-${idx}" class="font-bold text-blue-700">$${saldoPendiente.toLocaleString('es-CO', { maximumFractionDigits: 0 })}</span>`;
      }
      html += `<span class="text-gray-600">por persona</span>`;
      html += `</div>`;
      html += `<button type="button" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded font-semibold" onclick="pagoParcialeRonda('${acordeon.id}', ${idx})" title="Registrar pago parcial de esta ronda">💵 Pago Parcial</button>`;
      html += `<button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold" onclick="pagarRondaCompleta('${acordeon.id}', ${idx})" title="Pagar completamente la ronda ${idx + 1}">� Pago de Ronda ${idx + 1}</button>`;
      html += `</div>`;
      
      // Mostrar pagos parciales registrados si existen
      const pagosRegistrados = ronda.pagos || [];
      if (pagosRegistrados.length > 0) {
        let totalPagado = 0;
        html += `<div class="mt-3 p-2 bg-yellow-50 rounded border">`;
        html += `<h5 class="font-semibold text-green-700 mb-2">Pagos Registrados:</h5>`;
        pagosRegistrados.forEach((pago, pagoIdx) => {
          totalPagado += pago.monto;
          html += `<div class="flex justify-between items-center text-sm mb-1">`;
          html += `<span>${pago.persona}: $${pago.monto.toLocaleString('es-CO')} (${pago.metodo})</span>`;
          html += `<button type="button" class="text-red-600 hover:bg-red-100 px-1 rounded text-xs" onclick="eliminarPago('${acordeon.id}', ${idx}, ${pagoIdx})" title="Eliminar este pago">✕</button>`;
          html += `</div>`;
        });
        const saldo = ronda.total - totalPagado;
        html += `<hr class="my-2">`;
        html += `<div class="flex justify-between font-semibold">`;
        html += `<span>Total Ronda: $${ronda.total.toLocaleString('es-CO')}</span>`;
        html += `<span>Pagado: $${totalPagado.toLocaleString('es-CO')}</span>`;
        html += `</div>`;
        html += `<div class="flex justify-between font-bold ${saldo > 0 ? 'text-red-600' : 'text-green-600'}">`;
        html += `<span>SALDO: $${saldo.toLocaleString('es-CO')}</span>`;
        if (saldo <= 0) {
          html += `<span class="text-green-600">✅ PAGADO</span>`;
        }
        html += `</div>`;
        html += `</div>`;
      }
      html += `</div>`;
      // Responsables
      html += `<div class='flex flex-col gap-1 mt-2'>
        <label class='font-semibold'>Responsables de la ronda:</label>
        <textarea class='border rounded px-2 py-1 w-64 resize-y' rows='2' placeholder='Uno por línea' onchange='actualizarResponsable(this, ${idx})'>${ronda.responsable ? ronda.responsable : ''}</textarea>
        <small class='text-gray-500'>Puedes poner varios, uno por línea.</small>
      </div>`;
      html += `</div>`;
      contenidoDiv.innerHTML = html;
    }

    // Función para actualizar un producto específico
    window.actualizarProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      const tr = acordeon.querySelector(`tr[data-producto-idx="${productoIdx}"]`);
      if (!tr) return;

      const nombre = tr.querySelector('.producto-nombre').value;
      const cantidad = parseInt(tr.querySelector('.producto-cantidad').value) || 1;
      const precio = parseFloat(tr.querySelector('.producto-precio').value) || 0;
      const subtotal = cantidad * precio;

      // Actualizar producto
      rondas[rondaIdx].productos[productoIdx] = {nombre, cantidad, precio, subtotal};
      
      // Recalcular total de la ronda
      let totalRonda = 0;
      rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
      rondas[rondaIdx].total = totalRonda;

      // Guardar cambios
      acordeon.dataset.rondas = JSON.stringify(rondas);

      // Actualizar subtotal en la celda
      tr.querySelector('.producto-subtotal').textContent = subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });

      // Actualizar totales y renderizar
      renderizarRondas(acordeon);
    };

    // Función para eliminar un producto
    window.eliminarProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      if (rondas[rondaIdx].productos.length <= 1) {
        alert('No puedes eliminar el último producto de una ronda.');
        return;
      }

      // Eliminar producto
      rondas[rondaIdx].productos.splice(productoIdx, 1);
      
      // Recalcular total de la ronda
      let totalRonda = 0;
      rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
      rondas[rondaIdx].total = totalRonda;

      // Guardar cambios y renderizar
      acordeon.dataset.rondas = JSON.stringify(rondas);
      renderizarRondas(acordeon);
    };

    // Función para agregar un producto a una ronda
    window.agregarProductoRonda = function(acordeonId, rondaIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      const nuevoProducto = {
        nombre: 'Nuevo producto',
        cantidad: 1,
        precio: 0,
        subtotal: 0
      };

      rondas[rondaIdx].productos.push(nuevoProducto);
      acordeon.dataset.rondas = JSON.stringify(rondas);
      
      // Renderizar para mostrar el nuevo producto
      renderizarRondas(acordeon);
    };

    // Función para duplicar una ronda
    window.duplicarRonda = function(acordeonId, rondaIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      // Crear copia profunda de la ronda
      const rondaOriginal = rondas[rondaIdx];
      const rondaDuplicada = {
        productos: rondaOriginal.productos.map(p => ({
          nombre: p.nombre,
          cantidad: p.cantidad,
          precio: p.precio,
          subtotal: p.subtotal
        })),
        total: rondaOriginal.total,
        responsable: rondaOriginal.responsable
      };

      // Agregar la ronda duplicada
      rondas.push(rondaDuplicada);
      acordeon.dataset.rondas = JSON.stringify(rondas);
      
      // Renderizar y activar la nueva ronda
      acordeon._rondaActiva = rondas.length - 1;
      renderizarRondas(acordeon);
    };

    // Función para calcular división del saldo pendiente de la ronda
    window.calcularDivision = function(acordeonId, rondaIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      const ronda = rondas[rondaIdx];
      const totalRonda = ronda.total;
      
      // Calcular lo que ya se ha pagado
      const pagosRegistrados = ronda.pagos || [];
      let totalPagado = 0;
      pagosRegistrados.forEach(pago => totalPagado += pago.monto);
      const saldoPendiente = totalRonda - totalPagado;
      
      const divisorInput = document.getElementById(`dividir-${acordeonId}-${rondaIdx}`);
      const resultadoSpan = document.getElementById(`resultado-${acordeonId}-${rondaIdx}`);
      
      if (divisorInput && resultadoSpan) {
        const divisor = parseInt(divisorInput.value) || 1;
        const resultado = saldoPendiente / divisor;
        if (saldoPendiente <= 0) {
          resultadoSpan.textContent = `✅ PAGADO`;
          resultadoSpan.className = 'font-bold text-green-600';
        } else {
          resultadoSpan.textContent = `$${resultado.toLocaleString('es-CO', { maximumFractionDigits: 0 })}`;
          resultadoSpan.className = 'font-bold text-blue-700';
        }
      }
    };

    // Función para mostrar modal de método de pago
    window.mostrarModalMetodoPago = function() {
      return new Promise((resolve) => {
        // Crear modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-center">Método de Pago Recibido</h3>
            <div class="space-y-3">
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Efectivo 💵')">
                <span class="text-2xl">💵</span>
                <span class="font-semibold">Efectivo</span>
              </button>
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Nequi 📱')">
                <span class="text-2xl">📱</span>
                <span class="font-semibold">Nequi</span>
              </button>
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Daviplata 💳')">
                <span class="text-2xl">💳</span>
                <span class="font-semibold">Daviplata</span>
              </button>
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Transferencia 🏦')">
                <span class="text-2xl">🏦</span>
                <span class="font-semibold">Transferencia</span>
              </button>
            </div>
            <div class="flex justify-center mt-6">
              <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded" onclick="cancelarSeleccion()">Cancelar</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        window.seleccionarMetodo = function(metodo) {
          modal.remove();
          delete window.seleccionarMetodo;
          delete window.cancelarSeleccion;
          resolve(metodo);
        };
        
        window.cancelarSeleccion = function() {
          modal.remove();
          delete window.seleccionarMetodo;
          delete window.cancelarSeleccion;
          resolve(null);
        };
      });
    };

    // Función para marcar el pedido como pagado y eliminarlo
    window.marcarPagado = async function(acordeonId) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      // Calcular el total del pedido
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      let totalPedido = 0;
      rondas.forEach(r => totalPedido += r.total || 0);
      
      const nombreCliente = acordeon.querySelector('.font-semibold').textContent;
      
      if (!confirm(`¿Confirmas que se recibió el pago completo de ${totalPedido.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })} para ${nombreCliente}?\n\nEsto eliminará el pedido de la lista.`)) {
        return;
      }
      
      // Mostrar modal para seleccionar método de pago
      const metodoSeleccionado = await mostrarModalMetodoPago();
      
      if (!metodoSeleccionado) {
        return; // Usuario canceló
      }
      
      // Mostrar confirmación final con el método de pago
      if (!confirm(`Confirmar pago de ${totalPedido.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })} por ${metodoSeleccionado}?`)) {
        return;
      }
      
      // Mostrar mensaje de confirmación
      alert(`✅ Pago registrado exitosamente:\n\nCliente: ${nombreCliente}\nMonto: ${totalPedido.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}\nMétodo: ${metodoSeleccionado}\n\nPedido completado.`);
      
      // Animación de desvanecimiento antes de eliminar
      acordeon.style.transition = 'opacity 0.5s ease-out';
      acordeon.style.opacity = '0';
      
      setTimeout(() => {
        acordeon.remove();
      }, 500);
    };

    // Función para registrar pago parcial de una ronda
    window.pagoParcialeRonda = async function(acordeonId, rondaIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      const ronda = rondas[rondaIdx];
      const totalRonda = ronda.total;
      
      // Calcular lo que ya se ha pagado
      const pagosRegistrados = ronda.pagos || [];
      let totalPagado = 0;
      pagosRegistrados.forEach(pago => totalPagado += pago.monto);
      const saldoPendiente = totalRonda - totalPagado;
      
      if (saldoPendiente <= 0) {
        alert('Esta ronda ya está completamente pagada.');
        return;
      }

      // Pedir datos del pago parcial
      const personaPaga = prompt('¿Quién está pagando?', '');
      if (!personaPaga || !personaPaga.trim()) return;

      const montoPagoStr = prompt(
        `Saldo pendiente: $${saldoPendiente.toLocaleString('es-CO')}\n\n` +
        `¿Cuánto paga ${personaPaga.trim()}?`, 
        saldoPendiente
      );
      const montoPago = parseFloat(montoPagoStr);
      
      if (isNaN(montoPago) || montoPago <= 0) {
        alert('Monto inválido.');
        return;
      }
      
      if (montoPago > saldoPendiente) {
        alert(`El monto no puede ser mayor al saldo pendiente ($${saldoPendiente.toLocaleString('es-CO')})`);
        return;
      }

      // Seleccionar método de pago
      const metodoPago = await mostrarModalMetodoPago();
      if (!metodoPago) return;

      // Registrar el pago
      if (!ronda.pagos) ronda.pagos = [];
      ronda.pagos.push({
        persona: personaPaga.trim(),
        monto: montoPago,
        metodo: metodoPago,
        fecha: new Date().toLocaleString('es-CO')
      });

      // Guardar cambios y renderizar
      acordeon.dataset.rondas = JSON.stringify(rondas);
      renderizarRondas(acordeon);

      const nuevoSaldo = saldoPendiente - montoPago;
      if (nuevoSaldo <= 0) {
        alert(`✅ ¡Ronda completamente pagada!\n\nÚltimo pago: ${personaPaga.trim()} - $${montoPago.toLocaleString('es-CO')} (${metodoPago})`);
      } else {
        alert(`✅ Pago registrado:\n\n${personaPaga.trim()}: $${montoPago.toLocaleString('es-CO')} (${metodoPago})\nSaldo restante: $${nuevoSaldo.toLocaleString('es-CO')}`);
      }
    };

    // Función para eliminar un pago registrado
    window.eliminarPago = function(acordeonId, rondaIdx, pagoIdx) {
      if (!confirm('¿Eliminar este pago registrado?')) return;
      
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      if (rondas[rondaIdx].pagos && rondas[rondaIdx].pagos[pagoIdx]) {
        rondas[rondaIdx].pagos.splice(pagoIdx, 1);
        acordeon.dataset.rondas = JSON.stringify(rondas);
        renderizarRondas(acordeon);
      }
    };

    // Función para cambiar un producto por otro
    window.cambiarProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx] || !rondas[rondaIdx].productos[productoIdx]) return;

      const productoActual = rondas[rondaIdx].productos[productoIdx];
      const nuevoNombre = prompt(`Cambiar "${productoActual.nombre}" por:`, productoActual.nombre);
      
      if (nuevoNombre && nuevoNombre.trim() !== '') {
        const nuevoPrecioStr = prompt(`Precio del nuevo producto "${nuevoNombre.trim()}":`, productoActual.precio);
        const nuevoPrecio = parseFloat(nuevoPrecioStr) || 0;
        
        if (nuevoPrecio >= 0) {
          // Actualizar el producto
          rondas[rondaIdx].productos[productoIdx].nombre = nuevoNombre.trim();
          rondas[rondaIdx].productos[productoIdx].precio = nuevoPrecio;
          rondas[rondaIdx].productos[productoIdx].subtotal = rondas[rondaIdx].productos[productoIdx].cantidad * nuevoPrecio;
          
          // Recalcular total de la ronda
          let totalRonda = 0;
          rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
          rondas[rondaIdx].total = totalRonda;

          // Guardar cambios y renderizar
          acordeon.dataset.rondas = JSON.stringify(rondas);
          renderizarRondas(acordeon);
        }
      }
    };

    // Función para devolver un producto (crear descuento)
    window.devolverProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx] || !rondas[rondaIdx].productos[productoIdx]) return;

      const producto = rondas[rondaIdx].productos[productoIdx];
      const cantidadDevolver = prompt(`¿Cuántas unidades de "${producto.nombre}" devuelve el cliente?`, producto.cantidad);
      const cantidadNum = parseInt(cantidadDevolver);
      
      if (cantidadNum > 0 && cantidadNum <= producto.cantidad) {
        // Pedir el precio de descuento (menor al precio de venta)
        const precioDescuentoStr = prompt(
          `Precio de descuento por cada "${producto.nombre}" devuelto:\n` +
          `(Precio de venta: $${producto.precio.toLocaleString('es-CO')})\n` +
          `Ingresa el precio de descuento (normalmente menor):`, 
          Math.round(producto.precio * 0.7) // Sugerir 70% del precio de venta
        );
        const precioDescuento = parseFloat(precioDescuentoStr);
        
        if (isNaN(precioDescuento) || precioDescuento < 0) {
          alert('Precio de descuento inválido. Operación cancelada.');
          return;
        }

        if (cantidadNum === producto.cantidad) {
          // Devolver todo el producto - eliminarlo
          rondas[rondaIdx].productos.splice(productoIdx, 1);
        } else {
          // Devolver parcial - reducir cantidad
          producto.cantidad -= cantidadNum;
          producto.subtotal = producto.cantidad * producto.precio;
        }
        
        // Agregar línea de descuento por devolución con precio específico
        const totalDescuento = cantidadNum * precioDescuento;
        const descuento = {
          nombre: `DESCUENTO: ${cantidadNum} ${producto.nombre} devuelto(s) ($${precioDescuento.toLocaleString('es-CO')} c/u)`,
          cantidad: cantidadNum,
          precio: -precioDescuento,
          subtotal: -totalDescuento
        };
        rondas[rondaIdx].productos.push(descuento);
        
        // Recalcular total de la ronda
        let totalRonda = 0;
        rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
        rondas[rondaIdx].total = totalRonda;

        // Guardar cambios y renderizar
        acordeon.dataset.rondas = JSON.stringify(rondas);
        renderizarRondas(acordeon);
      } else if (cantidadNum > producto.cantidad) {
        alert(`No puedes devolver más de ${producto.cantidad} unidades.`);
      }
    };

    // Función para actualizar responsable de una ronda
    window.actualizarResponsable = function(textarea, rondaIdx) {
      const acordeon = textarea.closest('.border.rounded.shadow');
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      rondas[rondaIdx].responsable = textarea.value;
      acordeon.dataset.rondas = JSON.stringify(rondas);
    };

    // Modal para ver detalle de la ronda desde tabs
    window.verDetalleRondaTab = function(btn, idx) {
      const acordeon = btn.closest('.border.rounded.shadow');
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      const ronda = rondas[idx];
      if (!ronda) return;
      let html = `<table class='min-w-full text-sm text-left'><thead class='bg-gray-100'><tr><th class='px-2 py-1'>Producto</th><th class='px-2 py-1'>Cantidad</th><th class='px-2 py-1'>Precio Unitario</th><th class='px-2 py-1'>Subtotal</th></tr></thead><tbody>`;
      ronda.productos.forEach(p => {
        html += `<tr><td class='px-2 py-1'>${p.nombre}</td><td class='px-2 py-1'>${p.cantidad}</td><td class='px-2 py-1'>${p.precio.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td><td class='px-2 py-1'>${p.subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td></tr>`;
      });
      html += '</tbody></table>';
      let modalDetalle = document.getElementById('modalDetalleRondaTabs');
      if (!modalDetalle) {
        modalDetalle = document.createElement('div');
        modalDetalle.id = 'modalDetalleRondaTabs';
        modalDetalle.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
        modalDetalle.innerHTML = `<div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg"><h3 class="text-xl font-bold mb-4">Detalle de la ronda</h3><div id="detalleRondaTablaTabs"></div><div class="flex justify-end mt-6"><button type="button" id="btnCerrarDetalleTabs" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cerrar</button></div></div>`;
        document.body.appendChild(modalDetalle);
        document.getElementById('btnCerrarDetalleTabs').onclick = function() {
          modalDetalle.classList.add('hidden');
        };
      }
      document.getElementById('detalleRondaTablaTabs').innerHTML = html;
      modalDetalle.classList.remove('hidden');
    };
    // Lógica de acordeones de pedidos
    let pedidoId = 1;
    // Acordeón de prueba predefinido
    function crearAcordeonPrueba() {
      const acordeones = document.getElementById('acordeonesPedidos');
      const nombreCliente = 'Cliente Prueba';
      const id = 'pedido-0';
      const acordeon = document.createElement('div');
      acordeon.className = 'border rounded shadow';
      acordeon.id = id;
      acordeon.dataset.id = id;
      acordeon.innerHTML = `
        <div class="w-full flex justify-between items-center px-4 py-3 bg-gray-200 hover:bg-gray-300 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
          <span class="font-semibold">${nombreCliente} <span class='text-xs text-gray-500'>(Pedido #0)</span></span>
          <div class="flex items-center gap-2">
            <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-semibold" onclick="event.stopPropagation(); pagoCompletoTotal(this)" title="Pagar toda la deuda">💰 Pago Completo</button>
            <span class="total-pill bg-blue-600 text-white font-bold rounded-full px-4 py-1 text-base" style="min-width:120px;text-align:right;"></span>
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
          </div>
        </div>
        <div class="px-4 py-3 bg-white">
          <div class="flex gap-2 mb-4">
            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold" onclick="abrirModalRonda(this)">Crear ronda</button>
            <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-semibold" onclick="alquilarMesa(this)">🪑 Alquilar Mesa</button>
          </div>
          <div class="tabs-rondas flex gap-2 mb-4"></div>
          <div class="contenido-ronda"></div>
          <div class="mesa-alquilada hidden bg-purple-50 p-3 rounded border mb-4"></div>
          <div class="font-bold text-right mt-4 total-acumulado" style="display:none"></div>
        </div>
      `;
      // Datos de prueba: dos rondas
      acordeon.dataset.rondas = JSON.stringify([
        {
          productos: [
            {nombre: 'Cerveza', cantidad: 2, precio: 3500, subtotal: 7000},
            {nombre: 'Gaseosa', cantidad: 1, precio: 2500, subtotal: 2500}
          ],
          total: 9500,
          responsable: 'Juan'
        },
        {
          productos: [
            {nombre: 'Papas', cantidad: 1, precio: 4000, subtotal: 4000},
            {nombre: 'Agua', cantidad: 2, precio: 2000, subtotal: 4000}
          ],
          total: 8000,
          responsable: 'Pedro'
        }
      ]);
      acordeones.appendChild(acordeon);
      setTimeout(() => renderizarRondas(acordeon), 0);
    }
    // Crear acordeón de prueba al cargar la página
    window.addEventListener('DOMContentLoaded', crearAcordeonPrueba);
    document.getElementById('btnNuevoPedido').addEventListener('click', function() {
    const nombreCliente = prompt('Ingrese el nombre del cliente para este pedido:');
    if (!nombreCliente) return;
    const acordeones = document.getElementById('acordeonesPedidos');
    const id = pedidoId++;
    const acordeon = document.createElement('div');
    acordeon.className = 'border rounded shadow';
    acordeon.id = `pedido-${id}`;
    acordeon.dataset.id = `pedido-${id}`;
    acordeon.innerHTML = `
      <div class="w-full flex justify-between items-center px-4 py-3 bg-gray-200 hover:bg-gray-300 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
        <span class="font-semibold">${nombreCliente} <span class='text-xs text-gray-500'>(Pedido #${id})</span></span>
        <div class="flex items-center gap-2">
          <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-semibold" onclick="event.stopPropagation(); pagoCompletoTotal(this)" title="Pagar toda la deuda">💰 Pago Completo</button>
          <span class="total-pill bg-blue-600 text-white font-bold rounded-full px-4 py-1 text-base" style="min-width:120px;text-align:right;"></span>
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
        </div>
      </div>
      <div class="px-4 py-3 bg-white">
        <div class="flex gap-2 mb-4">
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold" onclick="abrirModalRonda(this)">Crear ronda</button>
          <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-semibold" onclick="alquilarMesa(this)">🪑 Alquilar Mesa</button>
        </div>
        <div class="tabs-rondas flex gap-2 mb-4"></div>
        <div class="contenido-ronda"></div>
        <div class="mesa-alquilada hidden bg-purple-50 p-3 rounded border mb-4"></div>
        <div class="font-bold text-right mt-4 total-acumulado" style="display:none"></div>
      </div>
    `;
    acordeon.dataset.rondas = JSON.stringify([]);
    acordeones.appendChild(acordeon);
    setTimeout(() => renderizarRondas(acordeon), 0);
  });

  // Sistema de alquiler de mesas
  const modalMesas = document.createElement('div');
  modalMesas.id = 'modalSeleccionMesa';
  modalMesas.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50';
  modalMesas.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">🪑 Seleccionar Mesa</h3>
          <button type="button" onclick="cerrarModalMesas()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button type="button" class="mesa-btn bg-purple-100 hover:bg-purple-200 border-2 border-purple-300 rounded-lg p-4 text-center transition-colors" data-mesa="1">
            <div class="text-2xl mb-2">🪑</div>
            <div class="font-semibold">Mesa 1</div>
            <div class="text-sm text-gray-600">$7,000/hora</div>
          </button>
          <button type="button" class="mesa-btn bg-purple-100 hover:bg-purple-200 border-2 border-purple-300 rounded-lg p-4 text-center transition-colors" data-mesa="2">
            <div class="text-2xl mb-2">🪑</div>
            <div class="font-semibold">Mesa 2</div>
            <div class="text-sm text-gray-600">$7,000/hora</div>
          </button>
          <button type="button" class="mesa-btn bg-purple-100 hover:bg-purple-200 border-2 border-purple-300 rounded-lg p-4 text-center transition-colors" data-mesa="3">
            <div class="text-2xl mb-2">🪑</div>
            <div class="font-semibold">Mesa 3</div>
            <div class="text-sm text-gray-600">$7,000/hora</div>
          </button>
          <button type="button" class="mesa-btn bg-purple-100 hover:bg-purple-200 border-2 border-purple-300 rounded-lg p-4 text-center transition-colors" data-mesa="4">
            <div class="text-2xl mb-2">🪑</div>
            <div class="font-semibold">Mesa 4</div>
            <div class="text-sm text-gray-600">$7,000/hora</div>
          </button>
        </div>
        <div class="mt-4 text-center text-sm text-gray-600">
          <div>💡 Precio: $7,000 pesos por hora</div>
          <div>⏱️ Se cobra por minutos exactos</div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modalMesas);

  // Variables globales para el sistema de mesas
  let acordeonActual = null;

  // Función para abrir modal de selección de mesa
  window.alquilarMesa = function(btn) {
    acordeonActual = btn.closest('.border.rounded.shadow');
    if (!acordeonActual) return;
    
    // Verificar si ya tiene una mesa alquilada
    const mesaDiv = acordeonActual.querySelector('.mesa-alquilada');
    if (mesaDiv && !mesaDiv.classList.contains('hidden')) {
      alert('Ya hay una mesa alquilada para este pedido. Termina el alquiler antes de seleccionar otra.');
      return;
    }
    
    document.getElementById('modalSeleccionMesa').classList.remove('hidden');
  };

  // Función para cerrar modal de mesas
  window.cerrarModalMesas = function() {
    document.getElementById('modalSeleccionMesa').classList.add('hidden');
    acordeonActual = null;
  };

  // Event listeners para selección de mesa
  document.querySelectorAll('.mesa-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const numeroMesa = this.dataset.mesa;
      iniciarAlquilerMesa(numeroMesa);
      cerrarModalMesas();
    });
  });

  // Función para iniciar el alquiler de una mesa
  function iniciarAlquilerMesa(numeroMesa) {
    if (!acordeonActual) return;
    
    const mesaDiv = acordeonActual.querySelector('.mesa-alquilada');
    const ahora = new Date();
    
    // Crear objeto de mesa alquilada
    const mesaData = {
      numero: numeroMesa,
      inicio: ahora.toISOString(),
      activa: true,
      precioHora: 7000
    };
    
    // Guardar datos en el acordeón
    acordeonActual.dataset.mesaAlquilada = JSON.stringify(mesaData);
    
    // Mostrar el div de mesa alquilada
    mesaDiv.classList.remove('hidden');
    mesaDiv.innerHTML = `
      <div class="flex justify-between items-center mb-3">
        <h4 class="font-semibold text-purple-700">🪑 Mesa ${numeroMesa} - Alquilada</h4>
        <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm" onclick="terminarAlquilerMesa(this)">Terminar</button>
      </div>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <div class="font-medium">Inicio:</div>
          <div class="text-gray-600">${ahora.toLocaleString('es-CO')}</div>
        </div>
        <div>
          <div class="font-medium">Tiempo transcurrido:</div>
          <div class="tiempo-transcurrido font-mono text-purple-700">00:00:00</div>
        </div>
        <div>
          <div class="font-medium">Costo actual:</div>
          <div class="costo-actual font-mono font-bold text-purple-700">$0</div>
        </div>
        <div>
          <div class="font-medium">Precio:</div>
          <div class="text-gray-600">$7,000/hora</div>
        </div>
      </div>
    `;
    
    // Iniciar el contador de tiempo
    iniciarContadorMesa(acordeonActual);
    
    // Mensaje de confirmación
    alert(`Mesa ${numeroMesa} alquilada correctamente. El contador ha iniciado.`);
  }

  // Función para iniciar el contador de tiempo de mesa
  function iniciarContadorMesa(acordeon) {
    // Limpiar cualquier intervalo existente
    if (acordeon.intervalMesa) {
      clearInterval(acordeon.intervalMesa);
    }
    
    acordeon.intervalMesa = setInterval(() => {
      actualizarContadorMesa(acordeon);
    }, 1000); // Actualizar cada segundo
  }

  // Función para actualizar el contador de tiempo y costo
  function actualizarContadorMesa(acordeon) {
    try {
      const mesaData = JSON.parse(acordeon.dataset.mesaAlquilada || '{}');
      if (!mesaData.activa) return;
      
      const inicio = new Date(mesaData.inicio);
      const ahora = new Date();
      const diferenciaMs = ahora - inicio;
      
      // Calcular tiempo transcurrido
      const horas = Math.floor(diferenciaMs / (1000 * 60 * 60));
      const minutos = Math.floor((diferenciaMs % (1000 * 60 * 60)) / (1000 * 60));
      const segundos = Math.floor((diferenciaMs % (1000 * 60)) / 1000);
      
      // Formatear tiempo
      const tiempoFormateado = 
        String(horas).padStart(2, '0') + ':' +
        String(minutos).padStart(2, '0') + ':' +
        String(segundos).padStart(2, '0');
      
      // Calcular costo (por minutos exactos)
      const minutosTotal = Math.floor(diferenciaMs / (1000 * 60));
      const costoTotal = Math.round((minutosTotal / 60) * mesaData.precioHora);
      
      // Actualizar display
      const tiempoDiv = acordeon.querySelector('.tiempo-transcurrido');
      const costoDiv = acordeon.querySelector('.costo-actual');
      
      if (tiempoDiv) tiempoDiv.textContent = tiempoFormateado;
      if (costoDiv) costoDiv.textContent = '$' + costoTotal.toLocaleString('es-CO');
      
    } catch (error) {
      console.error('Error actualizando contador de mesa:', error);
    }
  }

  // Función para terminar el alquiler de mesa
  window.terminarAlquilerMesa = function(btn) {
    const acordeon = btn.closest('.border.rounded.shadow');
    if (!acordeon) return;
    
    try {
      const mesaData = JSON.parse(acordeon.dataset.mesaAlquilada || '{}');
      if (!mesaData.activa) return;
      
      const inicio = new Date(mesaData.inicio);
      const fin = new Date();
      const diferenciaMs = fin - inicio;
      
      // Calcular tiempo total y costo final
      const minutosTotal = Math.ceil(diferenciaMs / (1000 * 60)); // Redondear hacia arriba
      const costoFinal = Math.round((minutosTotal / 60) * mesaData.precioHora);
      const horasCompletas = Math.floor(minutosTotal / 60);
      const minutosRestantes = minutosTotal % 60;
      
      // Confirmar terminación
      const mensaje = `Mesa ${mesaData.numero} - Resumen del alquiler:
      
🕐 Tiempo total: ${horasCompletas}h ${minutosRestantes}m
💰 Costo total: $${costoFinal.toLocaleString('es-CO')}

¿Confirmas terminar el alquiler?`;
      
      if (confirm(mensaje)) {
        // Marcar como inactiva
        mesaData.activa = false;
        mesaData.fin = fin.toISOString();
        mesaData.costoFinal = costoFinal;
        acordeon.dataset.mesaAlquilada = JSON.stringify(mesaData);
        
        // Limpiar intervalo
        if (acordeon.intervalMesa) {
          clearInterval(acordeon.intervalMesa);
          delete acordeon.intervalMesa;
        }
        
        // Actualizar display para mostrar resumen final
        const mesaDiv = acordeon.querySelector('.mesa-alquilada');
        mesaDiv.innerHTML = `
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold text-gray-700">🪑 Mesa ${mesaData.numero} - Terminada</h4>
            <button class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm" onclick="ocultarResumenMesa(this)">Ocultar</button>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <div class="font-medium">Inicio:</div>
              <div class="text-gray-600">${inicio.toLocaleString('es-CO')}</div>
            </div>
            <div>
              <div class="font-medium">Fin:</div>
              <div class="text-gray-600">${fin.toLocaleString('es-CO')}</div>
            </div>
            <div>
              <div class="font-medium">Tiempo total:</div>
              <div class="font-mono text-gray-700">${horasCompletas}h ${minutosRestantes}m</div>
            </div>
            <div>
              <div class="font-medium">Costo final:</div>
              <div class="font-mono font-bold text-green-600">$${costoFinal.toLocaleString('es-CO')}</div>
            </div>
          </div>
          <div class="mt-3 p-2 bg-green-50 rounded text-center text-sm text-green-700">
            ✅ Alquiler completado - Agregar $${costoFinal.toLocaleString('es-CO')} a la cuenta
          </div>
        `;
        
        alert(`Alquiler terminado correctamente.\nCosto total: $${costoFinal.toLocaleString('es-CO')}`);
      }
    } catch (error) {
      console.error('Error terminando alquiler de mesa:', error);
      alert('Error al terminar el alquiler. Inténtalo de nuevo.');
    }
  };

  // Función para ocultar el resumen de mesa
  window.ocultarResumenMesa = function(btn) {
    const mesaDiv = btn.closest('.mesa-alquilada');
    if (mesaDiv) {
      mesaDiv.classList.add('hidden');
    }
  };

  // Limpiar intervalos al cerrar/recargar la página
  window.addEventListener('beforeunload', function() {
    document.querySelectorAll('.border.rounded.shadow').forEach(acordeon => {
      if (acordeon.intervalMesa) {
        clearInterval(acordeon.intervalMesa);
      }
    });
  });

  // Restaurar contadores de mesa activos al cargar la página
  window.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      document.querySelectorAll('.border.rounded.shadow').forEach(acordeon => {
        try {
          const mesaData = JSON.parse(acordeon.dataset.mesaAlquilada || '{}');
          if (mesaData.activa) {
            iniciarContadorMesa(acordeon);
          }
        } catch (error) {
          // Ignorar errores de parsing
        }
      });
    }, 500);
  });

  // Función para pago completo de todas las rondas
  window.pagoCompletoTotal = function(btn) {
    const acordeon = btn.closest('.border.rounded.shadow');
    if (!acordeon) return;
    
    let rondas = [];
    try {
      rondas = JSON.parse(acordeon.dataset.rondas || '[]');
    } catch {
      rondas = [];
    }
    
    if (!Array.isArray(rondas) || rondas.length === 0) {
      alert('No hay rondas para pagar.');
      return;
    }
    
    // Calcular saldo total de todas las rondas
    let saldoTotal = 0;
    const rondasConSaldo = [];
    
    rondas.forEach((ronda, idx) => {
      const pagos = ronda.pagos || [];
      const totalPagado = pagos.reduce((sum, pago) => sum + pago.monto, 0);
      const saldoRonda = ronda.total - totalPagado;
      
      if (saldoRonda > 0) {
        saldoTotal += saldoRonda;
        rondasConSaldo.push({
          indice: idx,
          nombre: `Ronda ${idx + 1}`,
          total: ronda.total,
          pagado: totalPagado,
          saldo: saldoRonda
        });
      }
    });
    
    if (saldoTotal <= 0) {
      alert('No hay saldo pendiente para pagar.');
      return;
    }
    
    // Confirmar el pago
    let mensaje = `💰 PAGO COMPLETO DE TODAS LAS RONDAS\n\n`;
    mensaje += `Rondas con saldo pendiente:\n`;
    rondasConSaldo.forEach(r => {
      mensaje += `• ${r.nombre}: $${r.saldo.toLocaleString('es-CO')}\n`;
    });
    mensaje += `\n💳 TOTAL A PAGAR: $${saldoTotal.toLocaleString('es-CO')}\n\n`;
    mensaje += `¿Confirmas realizar el pago completo?`;
    
    if (confirm(mensaje)) {
      // Mostrar modal de método de pago para el total
      mostrarModalMetodoPagoTotal(acordeon, saldoTotal, rondasConSaldo);
    }
  };

  // Modal y función para método de pago total
  function mostrarModalMetodoPagoTotal(acordeon, montoTotal, rondasConSaldo) {
    // Crear modal si no existe
    let modal = document.getElementById('modalMetodoPagoTotal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'modalMetodoPagoTotal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">💰 Pago Completo</h3>
              <button type="button" onclick="cerrarModalMetodoPagoTotal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="mb-4">
              <div class="text-center mb-4">
                <div class="text-2xl font-bold text-green-600" id="montoTotalPago"></div>
                <div class="text-sm text-gray-600">Total a pagar</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button type="button" class="metodo-btn bg-green-100 hover:bg-green-200 border-2 border-green-300 rounded-lg p-4 text-center transition-colors" data-metodo="Efectivo">
                <div class="text-2xl mb-2">💵</div>
                <div class="font-semibold">Efectivo</div>
              </button>
              <button type="button" class="metodo-btn bg-purple-100 hover:bg-purple-200 border-2 border-purple-300 rounded-lg p-4 text-center transition-colors" data-metodo="Nequi">
                <div class="text-2xl mb-2">📱</div>
                <div class="font-semibold">Nequi</div>
              </button>
              <button type="button" class="metodo-btn bg-orange-100 hover:bg-orange-200 border-2 border-orange-300 rounded-lg p-4 text-center transition-colors" data-metodo="Daviplata">
                <div class="text-2xl mb-2">🏦</div>
                <div class="font-semibold">Daviplata</div>
              </button>
              <button type="button" class="metodo-btn bg-blue-100 hover:bg-blue-200 border-2 border-blue-300 rounded-lg p-4 text-center transition-colors" data-metodo="Transferencia">
                <div class="text-2xl mb-2">🔄</div>
                <div class="font-semibold">Transferencia</div>
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Event listeners para los botones de método
      modal.querySelectorAll('.metodo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const metodo = this.dataset.metodo;
          procesarPagoCompletoTotal(metodo);
        });
      });
    }
    
    // Actualizar monto y mostrar modal
    document.getElementById('montoTotalPago').textContent = '$' + montoTotal.toLocaleString('es-CO');
    
    // Guardar datos temporales
    window.datosPagoTotal = {
      acordeon: acordeon,
      monto: montoTotal,
      rondas: rondasConSaldo
    };
    
    modal.classList.remove('hidden');
  }

  // Función para cerrar modal de método de pago total
  window.cerrarModalMetodoPagoTotal = function() {
    const modal = document.getElementById('modalMetodoPagoTotal');
    if (modal) {
      modal.classList.add('hidden');
    }
    delete window.datosPagoTotal;
  };

  // Función para procesar el pago completo total
  function procesarPagoCompletoTotal(metodo) {
    const datos = window.datosPagoTotal;
    if (!datos) return;
    
    const { acordeon, monto, rondas: rondasConSaldo } = datos;
    const nombrePersona = prompt('¿Quién está realizando el pago completo?') || 'Anónimo';
    
    if (!nombrePersona) return;
    
    // Obtener rondas actuales
    let rondas = [];
    try {
      rondas = JSON.parse(acordeon.dataset.rondas || '[]');
    } catch {
      rondas = [];
    }
    
    // Pagar cada ronda completamente
    const fechaPago = new Date().toLocaleDateString('es-CO');
    let totalPagado = 0;
    
    rondasConSaldo.forEach(rondaInfo => {
      const ronda = rondas[rondaInfo.indice];
      if (!ronda) return;
      
      if (!ronda.pagos) ronda.pagos = [];
      
      // Agregar pago por el saldo restante
      const pago = {
        persona: nombrePersona,
        monto: rondaInfo.saldo,
        metodo: metodo,
        fecha: fechaPago
      };
      
      ronda.pagos.push(pago);
      totalPagado += rondaInfo.saldo;
    });
    
    // Cerrar modal primero
    cerrarModalMetodoPagoTotal();
    
    // Obtener nombre del cliente antes de eliminar
    const nombreCliente = acordeon.querySelector('.font-semibold').textContent.split('(')[0].trim();
    
    // Como se pagó todo, eliminar el acordeón completo
    setTimeout(() => {
      alert(`🎉 ¡PEDIDO COMPLETADO!\n\n💰 Total pagado: $${totalPagado.toLocaleString('es-CO')}\n👤 Pagado por: ${nombrePersona}\n💳 Método: ${metodo}\n📅 Fecha: ${fechaPago}\n\nTodas las rondas de ${nombreCliente} han sido pagadas.\nEl pedido será eliminado de la lista.`);
      
      // Eliminar todo el acordeón del DOM
      acordeon.remove();
    }, 100);
  }

  // Función para pagar una ronda completa específica
  window.pagarRondaCompleta = function(acordeonId, rondaIdx) {
    const acordeon = document.getElementById(acordeonId);
    if (!acordeon) return;
    
    let rondas = [];
    try {
      rondas = JSON.parse(acordeon.dataset.rondas || '[]');
    } catch {
      rondas = [];
    }
    
    if (!Array.isArray(rondas) || !rondas[rondaIdx]) {
      alert('Ronda no encontrada.');
      return;
    }
    
    const ronda = rondas[rondaIdx];
    const pagos = ronda.pagos || [];
    const totalPagado = pagos.reduce((sum, pago) => sum + pago.monto, 0);
    const saldoPendiente = ronda.total - totalPagado;
    
    if (saldoPendiente <= 0) {
      alert('Esta ronda ya está completamente pagada.');
      return;
    }
    
    // Confirmar el pago de la ronda
    const mensaje = `💳 PAGO COMPLETO DE RONDA ${rondaIdx + 1}\n\n` +
                   `Total de la ronda: $${ronda.total.toLocaleString('es-CO')}\n` +
                   `Ya pagado: $${totalPagado.toLocaleString('es-CO')}\n` +
                   `Saldo pendiente: $${saldoPendiente.toLocaleString('es-CO')}\n\n` +
                   `¿Confirmas pagar el saldo restante de la ronda ${rondaIdx + 1}?`;
    
    if (confirm(mensaje)) {
      // Mostrar modal de método de pago para la ronda
      mostrarModalMetodoPagoRonda(acordeon, rondaIdx, saldoPendiente);
    }
  };

  // Modal y función para método de pago de ronda específica
  function mostrarModalMetodoPagoRonda(acordeon, rondaIdx, monto) {
    // Crear modal si no existe
    let modal = document.getElementById('modalMetodoPagoRonda');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'modalMetodoPagoRonda';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">💳 Pago de Ronda</h3>
              <button type="button" onclick="cerrarModalMetodoPagoRonda()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="mb-4">
              <div class="text-center mb-4">
                <div class="text-xl font-bold text-blue-600" id="rondaNumero"></div>
                <div class="text-2xl font-bold text-green-600" id="montoRondaPago"></div>
                <div class="text-sm text-gray-600">Saldo a pagar</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button type="button" class="metodo-ronda-btn bg-green-100 hover:bg-green-200 border-2 border-green-300 rounded-lg p-4 text-center transition-colors" data-metodo="Efectivo">
                <div class="text-2xl mb-2">💵</div>
                <div class="font-semibold">Efectivo</div>
              </button>
              <button type="button" class="metodo-ronda-btn bg-purple-100 hover:bg-purple-200 border-2 border-purple-300 rounded-lg p-4 text-center transition-colors" data-metodo="Nequi">
                <div class="text-2xl mb-2">📱</div>
                <div class="font-semibold">Nequi</div>
              </button>
              <button type="button" class="metodo-ronda-btn bg-orange-100 hover:bg-orange-200 border-2 border-orange-300 rounded-lg p-4 text-center transition-colors" data-metodo="Daviplata">
                <div class="text-2xl mb-2">🏦</div>
                <div class="font-semibold">Daviplata</div>
              </button>
              <button type="button" class="metodo-ronda-btn bg-blue-100 hover:bg-blue-200 border-2 border-blue-300 rounded-lg p-4 text-center transition-colors" data-metodo="Transferencia">
                <div class="text-2xl mb-2">🔄</div>
                <div class="font-semibold">Transferencia</div>
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Event listeners para los botones de método
      modal.querySelectorAll('.metodo-ronda-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const metodo = this.dataset.metodo;
          procesarPagoRonda(metodo);
        });
      });
    }
    
    // Actualizar información y mostrar modal
    document.getElementById('rondaNumero').textContent = `Ronda ${rondaIdx + 1}`;
    document.getElementById('montoRondaPago').textContent = '$' + monto.toLocaleString('es-CO');
    
    // Guardar datos temporales
    window.datosPagoRonda = {
      acordeon: acordeon,
      rondaIdx: rondaIdx,
      monto: monto
    };
    
    modal.classList.remove('hidden');
  }

  // Función para cerrar modal de método de pago de ronda
  window.cerrarModalMetodoPagoRonda = function() {
    const modal = document.getElementById('modalMetodoPagoRonda');
    if (modal) {
      modal.classList.add('hidden');
    }
    delete window.datosPagoRonda;
  };

  // Función para procesar el pago de ronda completa
  function procesarPagoRonda(metodo) {
    const datos = window.datosPagoRonda;
    if (!datos) return;
    
    const { acordeon, rondaIdx, monto } = datos;
    const nombrePersona = prompt(`¿Quién está pagando la ronda ${rondaIdx + 1}?`) || 'Anónimo';
    
    if (!nombrePersona) return;
    
    // Obtener rondas actuales
    let rondas = [];
    try {
      rondas = JSON.parse(acordeon.dataset.rondas || '[]');
    } catch {
      rondas = [];
    }
    
    const ronda = rondas[rondaIdx];
    if (!ronda) return;
    
    // Guardar información de la ronda antes de eliminarla
    const totalRonda = ronda.total;
    const numeroRonda = rondaIdx + 1;
    
    // ELIMINAR la ronda del array (ya está pagada completamente)
    rondas.splice(rondaIdx, 1);
    
    // Actualizar dataset con la ronda eliminada
    acordeon.dataset.rondas = JSON.stringify(rondas);
    
    // Cerrar modal
    cerrarModalMetodoPagoRonda();
    
    // Verificar si ya no quedan rondas ANTES de renderizar
    if (rondas.length === 0) {
      // Si no quedan rondas, eliminar todo el pedido
      const nombreCliente = acordeon.querySelector('.font-semibold').textContent.split('(')[0].trim();
      
      // Mostrar mensaje de finalización antes de eliminar
      setTimeout(() => {
        alert(`🎉 ¡PEDIDO COMPLETADO!\n\nTodas las rondas de ${nombreCliente} han sido pagadas.\n\nEl pedido será eliminado de la lista.`);
        
        // Eliminar todo el acordeón del DOM
        acordeon.remove();
      }, 100);
      
      return; // Salir de la función sin renderizar
    }
    
    // Renderizar de nuevo (esto actualizará automáticamente los totales globales)
    renderizarRondas(acordeon);
    
    // Mensaje de confirmación
    alert(`✅ Ronda ${numeroRonda} pagada y eliminada\n\n💰 Monto pagado: $${monto.toLocaleString('es-CO')}\n👤 Pagado por: ${nombrePersona}\n💳 Método: ${metodo}\n📅 Fecha: ${new Date().toLocaleDateString('es-CO')}\n\n🗑️ La ronda ha sido eliminada del pedido.\nRondas restantes: ${rondas.length}`);
  }

  </script>
</body>
</html>
