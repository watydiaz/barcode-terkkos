<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Cliente</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="w-full bg-blue-600 py-6 shadow fixed top-0 left-0 z-40">
    <h1 class="text-4xl font-bold text-white text-center">Gestión de Pedidos</h1>
  </div>
  <div class="w-full px-0 pt-24">
    <div id="acordeonesPedidos" class="space-y-4 w-full"></div>
  </div>

  <!-- Botón flotante para crear pedido -->
  <button id="btnNuevoPedido" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center text-3xl z-50">+</button>

  <script>
  // Agregar fila a la tabla tipo Excel (debe estar antes de abrirModalRonda)
  window.agregarFilaExcel = function agregarFilaExcel() {
    const tbody = modal.querySelector('tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-2 py-1"><input type="text" class="w-32 border rounded px-1 py-0.5" required></td>
      <td class="px-2 py-1"><input type="number" class="w-20 border rounded px-1 py-0.5" min="0" required></td>
      <td class="px-2 py-1"><input type="number" class="w-12 border rounded px-1 py-0.5 text-center" min="1" value="1" required></td>
      <td class="px-2 py-1 subtotal">$0</td>
      <td><button type="button" class="text-red-600 font-bold" onclick="this.closest('tr').remove()">✕</button></td>
    `;
    tbody.appendChild(tr);
  }
  // Modal global para crear ronda
  let modal = document.createElement('div');
  modal.id = 'modalRonda';
  modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl">
      <h3 class="text-xl font-bold mb-4">Crear ronda</h3>
      <div class="overflow-x-auto">
        <table id="tablaExcel" class="min-w-full text-sm text-left border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1">Producto</th>
              <th class="px-2 py-1">Precio Unitario</th>
              <th class="px-2 py-1">Cantidad</th>
              <th class="px-2 py-1">Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button id="btnAgregarFila" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Agregar producto</button>
      <div class="flex justify-end space-x-2 mt-6">
        <button type="button" id="btnCancelarModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cancelar</button>
        <button type="button" id="btnGuardarRondaModal" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Guardar ronda</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  // Asignar funcionalidad al botón de agregar producto
  document.getElementById('btnAgregarFila').onclick = agregarFilaExcel;

  // Actualizar subtotal en la tabla tipo Excel (modal) al cambiar precio o cantidad
  modal.addEventListener('input', function(e) {
    if (e.target && (e.target.matches('input[type="number"]') || e.target.matches('input[type="text"]'))) {
      const tr = e.target.closest('tr');
      if (!tr) return;
      const precioInput = tr.children[1].querySelector('input');
      const cantidadInput = tr.children[2].querySelector('input');
      if (!precioInput || !cantidadInput) return;
      const precio = parseFloat(precioInput.value) || 0;
      const cantidad = parseInt(cantidadInput.value) || 1;
      tr.querySelector('.subtotal').textContent = (precio * cantidad).toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
    }
  });

  // Botón cancelar cierra el modal
  document.getElementById('btnCancelarModal').onclick = function() {
    modal.classList.add('hidden');
  };

  // Funcionalidad para guardar la ronda y actualizar tabs
  document.getElementById('btnGuardarRondaModal').onclick = function() {
    // Esta función queda vacía, la lógica está en abrirModalRonda para evitar duplicidad
    return;
  };
  // Lógica para abrir el modal desde el acordeón correcto
  window.abrirModalRonda = function(btn) {
    if (!modal) return;
    modal.classList.remove('hidden');
    // Guardar referencia al acordeón actual
    const acordeon = btn.closest('.border.rounded.shadow');
    modal.dataset.targetAcordeon = acordeon ? acordeon.dataset.id || '' : '';
    // Limpiar tabla
    const tbody = modal.querySelector('tbody');
    tbody.innerHTML = '';
    agregarFilaExcel();
    // Reasignar eventos para evitar bloqueos
    document.getElementById('btnAgregarFila').onclick = agregarFilaExcel;
    document.getElementById('btnCancelarModal').onclick = function() {
      modal.classList.add('hidden');
    };
    document.getElementById('btnGuardarRondaModal').onclick = function() {
      const filas = Array.from(tbody.querySelectorAll('tr'));
      if (filas.length === 0) {
        alert('Agrega al menos un producto antes de guardar la ronda.');
        return;
      }
      let acordeonDestino;
      if (modal.dataset.targetAcordeon) {
        acordeonDestino = Array.from(document.querySelectorAll('.border.rounded.shadow')).find(a => (a.dataset.id || '') === modal.dataset.targetAcordeon);
        if (!acordeonDestino) acordeonDestino = document.querySelector('.border.rounded.shadow');
      } else {
        acordeonDestino = document.querySelector('.border.rounded.shadow');
      }
      if (!acordeonDestino) return;
      let total = 0;
      let productos = [];
      filas.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const nombre = tds[0].querySelector('input').value;
        const precio = parseFloat(tds[1].querySelector('input').value) || 0;
        const cantidad = parseInt(tds[2].querySelector('input').value) || 1;
        const subtotal = precio * cantidad;
        total += subtotal;
        productos.push({nombre, cantidad, precio, subtotal});
      });
      let rondas = [];
      try { rondas = JSON.parse(acordeonDestino.dataset.rondas || '[]'); } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      rondas.push({productos, total, responsable: ''});
      acordeonDestino.dataset.rondas = JSON.stringify(rondas);
      renderizarRondas(acordeonDestino);
      // Actualizar la cápsula de total
      const pill = acordeonDestino.querySelector('.total-pill');
      let totalAcumulado = 0;
      rondas.forEach(r => { totalAcumulado += r.total || 0; });
      if (pill) {
        pill.textContent = totalAcumulado.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      }
      modal.classList.add('hidden');
    };
    // Subtotal en el modal
    modal.addEventListener('input', function(e) {
      if (e.target && (e.target.matches('input[type="number"]') || e.target.matches('input[type="text"]'))) {
        const tr = e.target.closest('tr');
        if (!tr) return;
        const precioInput = tr.children[1].querySelector('input');
        const cantidadInput = tr.children[2].querySelector('input');
        if (!precioInput || !cantidadInput) return;
        const precio = parseFloat(precioInput.value) || 0;
        const cantidad = parseInt(cantidadInput.value) || 1;
        tr.querySelector('.subtotal').textContent = (precio * cantidad).toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      }
    });
  };

    // Renderiza las rondas como tabs y muestra totales
    function renderizarRondas(acordeon) {
      const tabsDiv = acordeon.querySelector('.tabs-rondas');
      const contenidoDiv = acordeon.querySelector('.contenido-ronda');
      const totalAcumuladoDiv = acordeon.querySelector('.total-acumulado');
      let rondas = [];
       try {
         rondas = JSON.parse(acordeon.dataset.rondas || '[]');
       } catch (e) {
         console.error('Error parsing rondas:', e);
       }
      if (!Array.isArray(rondas)) rondas = [];
      tabsDiv.innerHTML = '';
      contenidoDiv.innerHTML = '';
      let totalAcumulado = 0;
      // Determinar ronda activa (por defecto la 0)
      let rondaActiva = acordeon._rondaActiva ?? 0;
      if (rondaActiva >= rondas.length) rondaActiva = 0;
      // Paleta de colores pasteles suaves
      const pastelTabs = [
        {bg: 'bg-blue-200', text: 'text-blue-900', border: 'border-blue-300', info: 'bg-blue-50'},
        {bg: 'bg-green-200', text: 'text-green-900', border: 'border-green-300', info: 'bg-green-50'},
        {bg: 'bg-pink-200', text: 'text-pink-900', border: 'border-pink-300', info: 'bg-pink-50'},
        {bg: 'bg-yellow-200', text: 'text-yellow-900', border: 'border-yellow-300', info: 'bg-yellow-50'},
        {bg: 'bg-purple-200', text: 'text-purple-900', border: 'border-purple-300', info: 'bg-purple-50'},
        {bg: 'bg-teal-200', text: 'text-teal-900', border: 'border-teal-300', info: 'bg-teal-50'},
        {bg: 'bg-orange-200', text: 'text-orange-900', border: 'border-orange-300', info: 'bg-orange-50'}
      ];
      rondas.forEach((ronda, idx) => {
        totalAcumulado += ronda.total || 0;
        const color = pastelTabs[idx % pastelTabs.length];
        const isActive = idx === rondaActiva;
        const tabBtn = document.createElement('button');
        tabBtn.className = `px-4 py-2 rounded-t font-semibold border-b-2 ${isActive ? color.bg + ' ' + color.text + ' ' + color.border + ' shadow' : 'bg-gray-200 hover:bg-gray-300 border-transparent text-gray-800'}`;
        tabBtn.textContent = `Ronda #${idx+1}`;
        tabBtn.onclick = () => {
          acordeon._rondaActiva = idx;
          renderizarRondas(acordeon);
        };
        tabBtn.dataset.infoColor = color.info;
        tabsDiv.appendChild(tabBtn);
      });
      if (rondas.length > 0) {
        mostrarRonda(acordeon, rondaActiva);
      }
       totalAcumuladoDiv.textContent = 'Total del pedido: ' + (totalAcumulado > 0 ? totalAcumulado.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }) : '$ 0');
    }

    // Muestra el contenido de una ronda seleccionada
    function mostrarRonda(acordeon, idx) {
      const contenidoDiv = acordeon.querySelector('.contenido-ronda');
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      const ronda = rondas[idx];
      if (!ronda) return;
      // Obtener color de fondo de la tab activa
      const tabsDiv = acordeon.querySelector('.tabs-rondas');
      let bgColor = 'bg-blue-200';
      if (tabsDiv && tabsDiv.children[idx]) {
        // Buscar la clase bg-* de la pestaña activa
        const classList = Array.from(tabsDiv.children[idx].classList);
        const bgClass = classList.find(c => c.startsWith('bg-'));
        if (bgClass) bgColor = bgClass;
      }
      let html = `<div class='mb-2 flex flex-wrap gap-4 items-center'>`;
      html += `<span class='font-bold text-green-700'>Ronda #${idx+1} <span class='text-blue-700'>(${ronda.total.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })})</span></span>`;
      html += `</div>`;
      // Tabla de productos y responsables con fondo igual a la pestaña
      html += `<div class='rounded-lg p-4 mt-2 ${bgColor}'>`;
      html += `<div class='overflow-x-auto'><table class='min-w-full text-sm text-left border'>`;
      html += `<thead class='bg-gray-100'><tr><th class='px-2 py-1'>Producto</th><th class='px-2 py-1'>Cantidad</th><th class='px-2 py-1'>Precio Unitario</th><th class='px-2 py-1'>Subtotal</th></tr></thead><tbody>`;
      (ronda.productos || []).forEach(p => {
        html += `<tr><td class='px-2 py-1'>${p.nombre}</td><td class='px-2 py-1'>${p.cantidad}</td><td class='px-2 py-1'>${p.precio.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td><td class='px-2 py-1'>${p.subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td></tr>`;
      });
      html += `</tbody></table></div>`;
      // Responsables
      html += `<div class='flex flex-col gap-1 mt-2'>
        <label class='font-semibold'>Responsables de la ronda:</label>
        <textarea class='border rounded px-2 py-1 w-64 resize-y' rows='2' placeholder='Uno por línea' onchange='actualizarResponsable(this, ${idx})'>${ronda.responsable ? ronda.responsable : ''}</textarea>
        <small class='text-gray-500'>Puedes poner varios, uno por línea.</small>
      </div>`;
      html += `</div>`;
      contenidoDiv.innerHTML = html;
    }

    // Modal para ver detalle de la ronda desde tabs
    window.verDetalleRondaTab = function(btn, idx) {
      const acordeon = btn.closest('.border.rounded.shadow');
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      const ronda = rondas[idx];
      if (!ronda) return;
      let html = `<table class='min-w-full text-sm text-left'><thead class='bg-gray-100'><tr><th class='px-2 py-1'>Producto</th><th class='px-2 py-1'>Cantidad</th><th class='px-2 py-1'>Precio Unitario</th><th class='px-2 py-1'>Subtotal</th></tr></thead><tbody>`;
      ronda.productos.forEach(p => {
        html += `<tr><td class='px-2 py-1'>${p.nombre}</td><td class='px-2 py-1'>${p.cantidad}</td><td class='px-2 py-1'>${p.precio.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td><td class='px-2 py-1'>${p.subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td></tr>`;
      });
      html += '</tbody></table>';
      let modalDetalle = document.getElementById('modalDetalleRondaTabs');
      if (!modalDetalle) {
        modalDetalle = document.createElement('div');
        modalDetalle.id = 'modalDetalleRondaTabs';
        modalDetalle.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
        modalDetalle.innerHTML = `<div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg"><h3 class="text-xl font-bold mb-4">Detalle de la ronda</h3><div id="detalleRondaTablaTabs"></div><div class="flex justify-end mt-6"><button type="button" id="btnCerrarDetalleTabs" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cerrar</button></div></div>`;
        document.body.appendChild(modalDetalle);
        document.getElementById('btnCerrarDetalleTabs').onclick = function() {
          modalDetalle.classList.add('hidden');
        };
      }
      document.getElementById('detalleRondaTablaTabs').innerHTML = html;
      modalDetalle.classList.remove('hidden');
    };
    // Lógica de acordeones de pedidos
    let pedidoId = 1;
    // Acordeón de prueba predefinido
    function crearAcordeonPrueba() {
      const acordeones = document.getElementById('acordeonesPedidos');
      const nombreCliente = 'Cliente Prueba';
      const acordeon = document.createElement('div');
      acordeon.className = 'border rounded shadow';
      acordeon.innerHTML = `
        <button type="button" class="w-full flex justify-between items-center px-4 py-3 bg-gray-200 hover:bg-gray-300 focus:outline-none" onclick="this.nextElementSibling.classList.toggle('hidden')">
          <span class="font-semibold">${nombreCliente}</span>
          <span class="ml-auto mr-2 total-pill bg-blue-600 text-white font-bold rounded-full px-4 py-1 text-base" style="min-width:120px;text-align:right;"></span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div class="px-4 py-3 bg-white">
          <button class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold" onclick="abrirModalRonda(this)">Crear ronda</button>
          <div class="tabs-rondas flex gap-2 mb-4"></div>
          <div class="contenido-ronda"></div>
          <div class="font-bold text-right mt-4 total-acumulado" style="display:none"></div>
        </div>
      `;
      // Datos de prueba: dos rondas
      acordeon.dataset.rondas = JSON.stringify([
        {
          productos: [
            {nombre: 'Cerveza', cantidad: 2, precio: 3500, subtotal: 7000},
            {nombre: 'Gaseosa', cantidad: 1, precio: 2500, subtotal: 2500}
          ],
          total: 9500,
          responsable: 'Juan'
        },
        {
          productos: [
            {nombre: 'Papas', cantidad: 1, precio: 4000, subtotal: 4000},
            {nombre: 'Agua', cantidad: 2, precio: 2000, subtotal: 4000}
          ],
          total: 8000,
          responsable: 'Pedro'
        }
      ]);
      acordeones.appendChild(acordeon);
      setTimeout(() => renderizarRondas(acordeon), 0);
    }
    // Crear acordeón de prueba al cargar la página
    window.addEventListener('DOMContentLoaded', crearAcordeonPrueba);
    document.getElementById('btnNuevoPedido').addEventListener('click', function() {
    const nombreCliente = prompt('Ingrese el nombre del cliente para este pedido:');
    if (!nombreCliente) return;
    const acordeones = document.getElementById('acordeonesPedidos');
    const id = pedidoId++;
    const acordeon = document.createElement('div');
    acordeon.className = 'border rounded shadow';
    acordeon.innerHTML = `
      <button type="button" class="w-full flex justify-between items-center px-4 py-3 bg-gray-200 hover:bg-gray-300 focus:outline-none" onclick="this.nextElementSibling.classList.toggle('hidden')">
        <span class="font-semibold">${nombreCliente}</span>
        <span class="ml-auto mr-2 total-pill bg-blue-600 text-white font-bold rounded-full px-4 py-1 text-base" style="min-width:120px;text-align:right;"></span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div class="px-4 py-3 bg-white">
        <button class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold" onclick="abrirModalRonda(this)">Crear ronda</button>
        <div class="tabs-rondas flex gap-2 mb-4"></div>
        <div class="contenido-ronda"></div>
        <div class="font-bold text-right mt-4 total-acumulado" style="display:none"></div>
      </div>
    `;
    acordeon.dataset.rondas = JSON.stringify([]);
    acordeones.appendChild(acordeon);
    setTimeout(() => renderizarRondas(acordeon), 0);
  });
  </script>
</body>
</html>
