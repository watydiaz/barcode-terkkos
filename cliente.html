<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Cliente</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="w-full bg-blue-600 py-6 shadow fixed top-0 left-0 z-40">
    <h1 class="text-4xl font-bold text-white text-center">Gesti√≥n de Pedidos</h1>
  </div>
  <div class="w-full px-0 pt-24">
    <div id="acordeonesPedidos" class="space-y-4 w-full"></div>
  </div>

  <!-- Bot√≥n flotante para crear pedido -->
  <button id="btnNuevoPedido" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center text-3xl z-50">+</button>

  <script>
  // Agregar fila a la tabla tipo Excel (debe estar antes de abrirModalRonda)
  window.agregarFilaExcel = function agregarFilaExcel() {
    const tbody = modal.querySelector('tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-2 py-1"><input type="text" class="w-32 border rounded px-1 py-0.5" required></td>
      <td class="px-2 py-1"><input type="number" class="w-20 border rounded px-1 py-0.5" min="0" required></td>
      <td class="px-2 py-1"><input type="number" class="w-12 border rounded px-1 py-0.5 text-center" min="1" value="1" required></td>
      <td class="px-2 py-1 subtotal">$0</td>
      <td><button type="button" class="text-red-600 font-bold" onclick="this.closest('tr').remove()">‚úï</button></td>
    `;
    tbody.appendChild(tr);
  }
  // Modal global para crear ronda
  let modal = document.createElement('div');
  modal.id = 'modalRonda';
  modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl">
      <h3 class="text-xl font-bold mb-4">Crear ronda</h3>
      <div class="overflow-x-auto">
        <table id="tablaExcel" class="min-w-full text-sm text-left border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1">Producto</th>
              <th class="px-2 py-1">Precio Unitario</th>
              <th class="px-2 py-1">Cantidad</th>
              <th class="px-2 py-1">Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button id="btnAgregarFila" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Agregar producto</button>
      <div class="flex justify-end space-x-2 mt-6">
        <button type="button" id="btnCancelarModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cancelar</button>
        <button type="button" id="btnGuardarRondaModal" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Guardar ronda</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  // Asignar funcionalidad al bot√≥n de agregar producto
  document.getElementById('btnAgregarFila').onclick = agregarFilaExcel;

  // Actualizar subtotal en la tabla tipo Excel (modal) al cambiar precio o cantidad
  modal.addEventListener('input', function(e) {
    if (e.target && (e.target.matches('input[type="number"]') || e.target.matches('input[type="text"]'))) {
      const tr = e.target.closest('tr');
      if (!tr) return;
      const precioInput = tr.children[1].querySelector('input');
      const cantidadInput = tr.children[2].querySelector('input');
      if (!precioInput || !cantidadInput) return;
      const precio = parseFloat(precioInput.value) || 0;
      const cantidad = parseInt(cantidadInput.value) || 1;
      tr.querySelector('.subtotal').textContent = (precio * cantidad).toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
    }
  });

  // Bot√≥n cancelar cierra el modal
  document.getElementById('btnCancelarModal').onclick = function() {
    modal.classList.add('hidden');
  };

  // Funcionalidad para guardar la ronda y actualizar tabs
  document.getElementById('btnGuardarRondaModal').onclick = function() {
    // Esta funci√≥n queda vac√≠a, la l√≥gica est√° en abrirModalRonda para evitar duplicidad
    return;
  };
  // L√≥gica para abrir el modal desde el acorde√≥n correcto
  window.abrirModalRonda = function(btn) {
    if (!modal) return;
    modal.classList.remove('hidden');
    // Guardar referencia al acorde√≥n actual usando el id √∫nico
    const acordeon = btn.closest('.border.rounded.shadow');
    if (acordeon && acordeon.id) {
      modal.dataset.targetAcordeon = acordeon.id;
    } else {
      modal.dataset.targetAcordeon = '';
    }
    // Limpiar tabla
    const tbody = modal.querySelector('tbody');
    tbody.innerHTML = '';
    agregarFilaExcel();
    // Reasignar eventos para evitar bloqueos
    document.getElementById('btnAgregarFila').onclick = agregarFilaExcel;
    document.getElementById('btnCancelarModal').onclick = function() {
      modal.classList.add('hidden');
    };
    document.getElementById('btnGuardarRondaModal').onclick = function() {
      const filas = Array.from(tbody.querySelectorAll('tr'));
      if (filas.length === 0) {
        alert('Agrega al menos un producto antes de guardar la ronda.');
        return;
      }
      let acordeonDestino = null;
      if (modal.dataset.targetAcordeon) {
        acordeonDestino = document.getElementById(modal.dataset.targetAcordeon);
      }
      if (!acordeonDestino) return;
      let total = 0;
      let productos = [];
      filas.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const nombre = tds[0].querySelector('input').value;
        const precio = parseFloat(tds[1].querySelector('input').value) || 0;
        const cantidad = parseInt(tds[2].querySelector('input').value) || 1;
        const subtotal = precio * cantidad;
        total += subtotal;
        productos.push({nombre, cantidad, precio, subtotal});
      });
      let rondas = [];
      try { rondas = JSON.parse(acordeonDestino.dataset.rondas || '[]'); } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      rondas.push({productos, total, responsable: ''});
      acordeonDestino.dataset.rondas = JSON.stringify(rondas);
      renderizarRondas(acordeonDestino);
      // Actualizar la c√°psula de total
      const pill = acordeonDestino.querySelector('.total-pill');
      let totalAcumulado = 0;
      rondas.forEach(r => { totalAcumulado += r.total || 0; });
      if (pill) {
        pill.textContent = totalAcumulado.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      }
      modal.classList.add('hidden');
    };
    // Subtotal en el modal
    modal.addEventListener('input', function(e) {
      if (e.target && (e.target.matches('input[type="number"]') || e.target.matches('input[type="text"]'))) {
        const tr = e.target.closest('tr');
        if (!tr) return;
        const precioInput = tr.children[1].querySelector('input');
        const cantidadInput = tr.children[2].querySelector('input');
        if (!precioInput || !cantidadInput) return;
        const precio = parseFloat(precioInput.value) || 0;
        const cantidad = parseInt(cantidadInput.value) || 1;
        tr.querySelector('.subtotal').textContent = (precio * cantidad).toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      }
    });
  };

    // Renderiza las rondas como tabs y muestra totales
    function renderizarRondas(acordeon) {
      const tabsDiv = acordeon.querySelector('.tabs-rondas');
      const contenidoDiv = acordeon.querySelector('.contenido-ronda');
      const totalAcumuladoDiv = acordeon.querySelector('.total-acumulado');
      let rondas = [];
       try {
         rondas = JSON.parse(acordeon.dataset.rondas || '[]');
       } catch (e) {
         console.error('Error parsing rondas:', e);
       }
      if (!Array.isArray(rondas)) rondas = [];
      tabsDiv.innerHTML = '';
      contenidoDiv.innerHTML = '';
      let totalAcumulado = 0;
      // Determinar ronda activa (por defecto la 0)
      let rondaActiva = acordeon._rondaActiva ?? 0;
      if (rondaActiva >= rondas.length) rondaActiva = 0;
      // Paleta de colores pasteles suaves
      const pastelTabs = [
        {bg: 'bg-blue-200', text: 'text-blue-900', border: 'border-blue-300', info: 'bg-blue-50'},
        {bg: 'bg-green-200', text: 'text-green-900', border: 'border-green-300', info: 'bg-green-50'},
        {bg: 'bg-pink-200', text: 'text-pink-900', border: 'border-pink-300', info: 'bg-pink-50'},
        {bg: 'bg-yellow-200', text: 'text-yellow-900', border: 'border-yellow-300', info: 'bg-yellow-50'},
        {bg: 'bg-purple-200', text: 'text-purple-900', border: 'border-purple-300', info: 'bg-purple-50'},
        {bg: 'bg-teal-200', text: 'text-teal-900', border: 'border-teal-300', info: 'bg-teal-50'},
        {bg: 'bg-orange-200', text: 'text-orange-900', border: 'border-orange-300', info: 'bg-orange-50'}
      ];
      rondas.forEach((ronda, idx) => {
        totalAcumulado += ronda.total || 0;
        const color = pastelTabs[idx % pastelTabs.length];
        const isActive = idx === rondaActiva;
        const tabBtn = document.createElement('button');
        tabBtn.className = `px-4 py-2 rounded-t font-semibold border-b-2 ${isActive ? color.bg + ' ' + color.text + ' ' + color.border + ' shadow' : 'bg-gray-200 hover:bg-gray-300 border-transparent text-gray-800'}`;
        tabBtn.textContent = `Ronda #${idx+1}`;
        tabBtn.onclick = () => {
          acordeon._rondaActiva = idx;
          renderizarRondas(acordeon);
        };
        tabBtn.dataset.infoColor = color.info;
        tabsDiv.appendChild(tabBtn);
      });
      if (rondas.length > 0) {
        mostrarRonda(acordeon, rondaActiva);
      }
       totalAcumuladoDiv.textContent = 'Total del pedido: ' + (totalAcumulado > 0 ? totalAcumulado.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }) : '$ 0');
    }

    // Muestra el contenido de una ronda seleccionada
    function mostrarRonda(acordeon, idx) {
      const contenidoDiv = acordeon.querySelector('.contenido-ronda');
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      const ronda = rondas[idx];
      if (!ronda) return;
      // Obtener color de fondo de la tab activa
      const tabsDiv = acordeon.querySelector('.tabs-rondas');
      let bgColor = 'bg-blue-200';
      if (tabsDiv && tabsDiv.children[idx]) {
        // Buscar la clase bg-* de la pesta√±a activa
        const classList = Array.from(tabsDiv.children[idx].classList);
        const bgClass = classList.find(c => c.startsWith('bg-'));
        if (bgClass) bgColor = bgClass;
      }
      let html = `<div class='mb-2 flex flex-wrap gap-4 items-center'>`;
      html += `<span class='font-bold text-green-700'>Ronda #${idx+1} <span class='text-blue-700'>(${ronda.total.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })})</span></span>`;
      html += `</div>`;
      // Tabla de productos y responsables con fondo igual a la pesta√±a
      html += `<div class='rounded-lg p-4 mt-2 ${bgColor}'>`;
      html += `<div class='overflow-x-auto'><table class='min-w-full text-sm text-left border'>`;
      html += `<thead class='bg-gray-100'><tr><th class='px-2 py-1'>Producto</th><th class='px-2 py-1'>Cantidad</th><th class='px-2 py-1'>Precio Unitario</th><th class='px-2 py-1'>Subtotal</th><th class='px-2 py-1'>Acciones</th></tr></thead><tbody>`;
      (ronda.productos || []).forEach((p, prodIdx) => {
        html += `<tr data-producto-idx="${prodIdx}">`;
        html += `<td class='px-2 py-1'><input type="text" class="w-full border rounded px-1 py-0.5 producto-nombre" value="${p.nombre}" onchange="actualizarProducto('${acordeon.id}', ${idx}, ${prodIdx})"></td>`;
        html += `<td class='px-2 py-1'><input type="number" class="w-16 border rounded px-1 py-0.5 producto-cantidad" min="1" value="${p.cantidad}" onchange="actualizarProducto('${acordeon.id}', ${idx}, ${prodIdx})"></td>`;
        html += `<td class='px-2 py-1'><input type="number" class="w-20 border rounded px-1 py-0.5 producto-precio" min="0" value="${p.precio}" onchange="actualizarProducto('${acordeon.id}', ${idx}, ${prodIdx})"></td>`;
        html += `<td class='px-2 py-1 producto-subtotal'>${p.subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td>`;
        html += `<td class='px-2 py-1'>`;
        html += `<div class="flex gap-1">`;
        html += `<button type="button" class="text-blue-600 font-bold hover:bg-blue-100 px-1 py-1 rounded text-xs" onclick="cambiarProducto('${acordeon.id}', ${idx}, ${prodIdx})" title="Cambiar producto">üîÑ</button>`;
        html += `<button type="button" class="text-orange-600 font-bold hover:bg-orange-100 px-1 py-1 rounded text-xs" onclick="devolverProducto('${acordeon.id}', ${idx}, ${prodIdx})" title="Devolver producto (descuento)">‚Ü©Ô∏è</button>`;
        html += `<button type="button" class="text-red-600 font-bold hover:bg-red-100 px-1 py-1 rounded text-xs" onclick="eliminarProducto('${acordeon.id}', ${idx}, ${prodIdx})" title="Eliminar producto">‚úï</button>`;
        html += `</div>`;
        html += `</td>`;
        html += `</tr>`;
      });
      html += `</tbody></table></div>`;
      html += `<div class="flex flex-wrap gap-2 mt-2">`;
      html += `<button type="button" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm" onclick="agregarProductoRonda('${acordeon.id}', ${idx})">+ Agregar producto</button>`;
      // Mostrar bot√≥n duplicar solo en la √∫ltima ronda
      if (idx === rondas.length - 1) {
        html += `<button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm" onclick="duplicarRonda('${acordeon.id}', ${idx})" title="Duplicar esta ronda">üìã Duplicar ronda</button>`;
      }
      html += `</div>`;
      
      // Secci√≥n de c√°lculo dividido y pago
      html += `<div class="mt-4 p-3 bg-gray-50 rounded border">`;
      html += `<div class="flex flex-wrap items-center gap-2 mb-2">`;
      html += `<span class="font-semibold">Dividir entre:</span>`;
      html += `<input type="number" id="dividir-${acordeon.id}-${idx}" class="w-16 border rounded px-2 py-1 text-center" min="1" value="1" onchange="calcularDivision('${acordeon.id}', ${idx})">`;
      html += `<span class="font-semibold">personas =</span>`;
      html += `<span id="resultado-${acordeon.id}-${idx}" class="font-bold text-blue-700">$${(ronda.total).toLocaleString('es-CO', { maximumFractionDigits: 0 })}</span>`;
      html += `<span class="text-gray-600">por persona</span>`;
      html += `</div>`;
      html += `<button type="button" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-semibold" onclick="marcarPagado('${acordeon.id}')" title="Marcar todo el pedido como pagado y eliminarlo">üí∞ Pago Recibido</button>`;
      html += `</div>`;
      html += `</div>`;
      // Responsables
      html += `<div class='flex flex-col gap-1 mt-2'>
        <label class='font-semibold'>Responsables de la ronda:</label>
        <textarea class='border rounded px-2 py-1 w-64 resize-y' rows='2' placeholder='Uno por l√≠nea' onchange='actualizarResponsable(this, ${idx})'>${ronda.responsable ? ronda.responsable : ''}</textarea>
        <small class='text-gray-500'>Puedes poner varios, uno por l√≠nea.</small>
      </div>`;
      html += `</div>`;
      contenidoDiv.innerHTML = html;
    }

    // Funci√≥n para actualizar un producto espec√≠fico
    window.actualizarProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      const tr = acordeon.querySelector(`tr[data-producto-idx="${productoIdx}"]`);
      if (!tr) return;

      const nombre = tr.querySelector('.producto-nombre').value;
      const cantidad = parseInt(tr.querySelector('.producto-cantidad').value) || 1;
      const precio = parseFloat(tr.querySelector('.producto-precio').value) || 0;
      const subtotal = cantidad * precio;

      // Actualizar producto
      rondas[rondaIdx].productos[productoIdx] = {nombre, cantidad, precio, subtotal};
      
      // Recalcular total de la ronda
      let totalRonda = 0;
      rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
      rondas[rondaIdx].total = totalRonda;

      // Guardar cambios
      acordeon.dataset.rondas = JSON.stringify(rondas);

      // Actualizar subtotal en la celda
      tr.querySelector('.producto-subtotal').textContent = subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });

      // Actualizar totales y renderizar
      renderizarRondas(acordeon);
    };

    // Funci√≥n para eliminar un producto
    window.eliminarProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      if (rondas[rondaIdx].productos.length <= 1) {
        alert('No puedes eliminar el √∫ltimo producto de una ronda.');
        return;
      }

      // Eliminar producto
      rondas[rondaIdx].productos.splice(productoIdx, 1);
      
      // Recalcular total de la ronda
      let totalRonda = 0;
      rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
      rondas[rondaIdx].total = totalRonda;

      // Guardar cambios y renderizar
      acordeon.dataset.rondas = JSON.stringify(rondas);
      renderizarRondas(acordeon);
    };

    // Funci√≥n para agregar un producto a una ronda
    window.agregarProductoRonda = function(acordeonId, rondaIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      const nuevoProducto = {
        nombre: 'Nuevo producto',
        cantidad: 1,
        precio: 0,
        subtotal: 0
      };

      rondas[rondaIdx].productos.push(nuevoProducto);
      acordeon.dataset.rondas = JSON.stringify(rondas);
      
      // Renderizar para mostrar el nuevo producto
      renderizarRondas(acordeon);
    };

    // Funci√≥n para duplicar una ronda
    window.duplicarRonda = function(acordeonId, rondaIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      // Crear copia profunda de la ronda
      const rondaOriginal = rondas[rondaIdx];
      const rondaDuplicada = {
        productos: rondaOriginal.productos.map(p => ({
          nombre: p.nombre,
          cantidad: p.cantidad,
          precio: p.precio,
          subtotal: p.subtotal
        })),
        total: rondaOriginal.total,
        responsable: rondaOriginal.responsable
      };

      // Agregar la ronda duplicada
      rondas.push(rondaDuplicada);
      acordeon.dataset.rondas = JSON.stringify(rondas);
      
      // Renderizar y activar la nueva ronda
      acordeon._rondaActiva = rondas.length - 1;
      renderizarRondas(acordeon);
    };

    // Funci√≥n para calcular divisi√≥n del total de la ronda
    window.calcularDivision = function(acordeonId, rondaIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      const totalRonda = rondas[rondaIdx].total;
      const divisorInput = document.getElementById(`dividir-${acordeonId}-${rondaIdx}`);
      const resultadoSpan = document.getElementById(`resultado-${acordeonId}-${rondaIdx}`);
      
      if (divisorInput && resultadoSpan) {
        const divisor = parseInt(divisorInput.value) || 1;
        const resultado = totalRonda / divisor;
        resultadoSpan.textContent = `$${resultado.toLocaleString('es-CO', { maximumFractionDigits: 0 })}`;
      }
    };

    // Funci√≥n para mostrar modal de m√©todo de pago
    window.mostrarModalMetodoPago = function() {
      return new Promise((resolve) => {
        // Crear modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-center">M√©todo de Pago Recibido</h3>
            <div class="space-y-3">
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Efectivo üíµ')">
                <span class="text-2xl">üíµ</span>
                <span class="font-semibold">Efectivo</span>
              </button>
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Nequi üì±')">
                <span class="text-2xl">üì±</span>
                <span class="font-semibold">Nequi</span>
              </button>
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Daviplata üí≥')">
                <span class="text-2xl">üí≥</span>
                <span class="font-semibold">Daviplata</span>
              </button>
              <button type="button" class="w-full p-3 text-left border rounded hover:bg-gray-50 flex items-center gap-3" onclick="seleccionarMetodo('Transferencia üè¶')">
                <span class="text-2xl">üè¶</span>
                <span class="font-semibold">Transferencia</span>
              </button>
            </div>
            <div class="flex justify-center mt-6">
              <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded" onclick="cancelarSeleccion()">Cancelar</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        window.seleccionarMetodo = function(metodo) {
          modal.remove();
          delete window.seleccionarMetodo;
          delete window.cancelarSeleccion;
          resolve(metodo);
        };
        
        window.cancelarSeleccion = function() {
          modal.remove();
          delete window.seleccionarMetodo;
          delete window.cancelarSeleccion;
          resolve(null);
        };
      });
    };

    // Funci√≥n para marcar el pedido como pagado y eliminarlo
    window.marcarPagado = async function(acordeonId) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      // Calcular el total del pedido
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      let totalPedido = 0;
      rondas.forEach(r => totalPedido += r.total || 0);
      
      const nombreCliente = acordeon.querySelector('.font-semibold').textContent;
      
      if (!confirm(`¬øConfirmas que se recibi√≥ el pago completo de ${totalPedido.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })} para ${nombreCliente}?\n\nEsto eliminar√° el pedido de la lista.`)) {
        return;
      }
      
      // Mostrar modal para seleccionar m√©todo de pago
      const metodoSeleccionado = await mostrarModalMetodoPago();
      
      if (!metodoSeleccionado) {
        return; // Usuario cancel√≥
      }
      
      // Mostrar confirmaci√≥n final con el m√©todo de pago
      if (!confirm(`Confirmar pago de ${totalPedido.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })} por ${metodoSeleccionado}?`)) {
        return;
      }
      
      // Mostrar mensaje de confirmaci√≥n
      alert(`‚úÖ Pago registrado exitosamente:\n\nCliente: ${nombreCliente}\nMonto: ${totalPedido.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}\nM√©todo: ${metodoSeleccionado}\n\nPedido completado.`);
      
      // Animaci√≥n de desvanecimiento antes de eliminar
      acordeon.style.transition = 'opacity 0.5s ease-out';
      acordeon.style.opacity = '0';
      
      setTimeout(() => {
        acordeon.remove();
      }, 500);
    };

    // Funci√≥n para cambiar un producto por otro
    window.cambiarProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx] || !rondas[rondaIdx].productos[productoIdx]) return;

      const productoActual = rondas[rondaIdx].productos[productoIdx];
      const nuevoNombre = prompt(`Cambiar "${productoActual.nombre}" por:`, productoActual.nombre);
      
      if (nuevoNombre && nuevoNombre.trim() !== '') {
        const nuevoPrecioStr = prompt(`Precio del nuevo producto "${nuevoNombre.trim()}":`, productoActual.precio);
        const nuevoPrecio = parseFloat(nuevoPrecioStr) || 0;
        
        if (nuevoPrecio >= 0) {
          // Actualizar el producto
          rondas[rondaIdx].productos[productoIdx].nombre = nuevoNombre.trim();
          rondas[rondaIdx].productos[productoIdx].precio = nuevoPrecio;
          rondas[rondaIdx].productos[productoIdx].subtotal = rondas[rondaIdx].productos[productoIdx].cantidad * nuevoPrecio;
          
          // Recalcular total de la ronda
          let totalRonda = 0;
          rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
          rondas[rondaIdx].total = totalRonda;

          // Guardar cambios y renderizar
          acordeon.dataset.rondas = JSON.stringify(rondas);
          renderizarRondas(acordeon);
        }
      }
    };

    // Funci√≥n para devolver un producto (crear descuento)
    window.devolverProducto = function(acordeonId, rondaIdx, productoIdx) {
      const acordeon = document.getElementById(acordeonId);
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx] || !rondas[rondaIdx].productos[productoIdx]) return;

      const producto = rondas[rondaIdx].productos[productoIdx];
      const cantidadDevolver = prompt(`¬øCu√°ntas unidades de "${producto.nombre}" devuelve el cliente?`, producto.cantidad);
      const cantidadNum = parseInt(cantidadDevolver);
      
      if (cantidadNum > 0 && cantidadNum <= producto.cantidad) {
        // Pedir el precio de descuento (menor al precio de venta)
        const precioDescuentoStr = prompt(
          `Precio de descuento por cada "${producto.nombre}" devuelto:\n` +
          `(Precio de venta: $${producto.precio.toLocaleString('es-CO')})\n` +
          `Ingresa el precio de descuento (normalmente menor):`, 
          Math.round(producto.precio * 0.7) // Sugerir 70% del precio de venta
        );
        const precioDescuento = parseFloat(precioDescuentoStr);
        
        if (isNaN(precioDescuento) || precioDescuento < 0) {
          alert('Precio de descuento inv√°lido. Operaci√≥n cancelada.');
          return;
        }

        if (cantidadNum === producto.cantidad) {
          // Devolver todo el producto - eliminarlo
          rondas[rondaIdx].productos.splice(productoIdx, 1);
        } else {
          // Devolver parcial - reducir cantidad
          producto.cantidad -= cantidadNum;
          producto.subtotal = producto.cantidad * producto.precio;
        }
        
        // Agregar l√≠nea de descuento por devoluci√≥n con precio espec√≠fico
        const totalDescuento = cantidadNum * precioDescuento;
        const descuento = {
          nombre: `DESCUENTO: ${cantidadNum} ${producto.nombre} devuelto(s) ($${precioDescuento.toLocaleString('es-CO')} c/u)`,
          cantidad: cantidadNum,
          precio: -precioDescuento,
          subtotal: -totalDescuento
        };
        rondas[rondaIdx].productos.push(descuento);
        
        // Recalcular total de la ronda
        let totalRonda = 0;
        rondas[rondaIdx].productos.forEach(p => totalRonda += p.subtotal);
        rondas[rondaIdx].total = totalRonda;

        // Guardar cambios y renderizar
        acordeon.dataset.rondas = JSON.stringify(rondas);
        renderizarRondas(acordeon);
      } else if (cantidadNum > producto.cantidad) {
        alert(`No puedes devolver m√°s de ${producto.cantidad} unidades.`);
      }
    };

    // Funci√≥n para actualizar responsable de una ronda
    window.actualizarResponsable = function(textarea, rondaIdx) {
      const acordeon = textarea.closest('.border.rounded.shadow');
      if (!acordeon) return;
      
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas) || !rondas[rondaIdx]) return;

      rondas[rondaIdx].responsable = textarea.value;
      acordeon.dataset.rondas = JSON.stringify(rondas);
    };

    // Modal para ver detalle de la ronda desde tabs
    window.verDetalleRondaTab = function(btn, idx) {
      const acordeon = btn.closest('.border.rounded.shadow');
      let rondas = [];
      try {
        rondas = JSON.parse(acordeon.dataset.rondas || '[]');
      } catch {}
      if (!Array.isArray(rondas)) rondas = [];
      const ronda = rondas[idx];
      if (!ronda) return;
      let html = `<table class='min-w-full text-sm text-left'><thead class='bg-gray-100'><tr><th class='px-2 py-1'>Producto</th><th class='px-2 py-1'>Cantidad</th><th class='px-2 py-1'>Precio Unitario</th><th class='px-2 py-1'>Subtotal</th></tr></thead><tbody>`;
      ronda.productos.forEach(p => {
        html += `<tr><td class='px-2 py-1'>${p.nombre}</td><td class='px-2 py-1'>${p.cantidad}</td><td class='px-2 py-1'>${p.precio.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td><td class='px-2 py-1'>${p.subtotal.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })}</td></tr>`;
      });
      html += '</tbody></table>';
      let modalDetalle = document.getElementById('modalDetalleRondaTabs');
      if (!modalDetalle) {
        modalDetalle = document.createElement('div');
        modalDetalle.id = 'modalDetalleRondaTabs';
        modalDetalle.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
        modalDetalle.innerHTML = `<div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg"><h3 class="text-xl font-bold mb-4">Detalle de la ronda</h3><div id="detalleRondaTablaTabs"></div><div class="flex justify-end mt-6"><button type="button" id="btnCerrarDetalleTabs" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cerrar</button></div></div>`;
        document.body.appendChild(modalDetalle);
        document.getElementById('btnCerrarDetalleTabs').onclick = function() {
          modalDetalle.classList.add('hidden');
        };
      }
      document.getElementById('detalleRondaTablaTabs').innerHTML = html;
      modalDetalle.classList.remove('hidden');
    };
    // L√≥gica de acordeones de pedidos
    let pedidoId = 1;
    // Acorde√≥n de prueba predefinido
    function crearAcordeonPrueba() {
      const acordeones = document.getElementById('acordeonesPedidos');
      const nombreCliente = 'Cliente Prueba';
      const id = 'pedido-0';
      const acordeon = document.createElement('div');
      acordeon.className = 'border rounded shadow';
      acordeon.id = id;
      acordeon.dataset.id = id;
      acordeon.innerHTML = `
        <button type="button" class="w-full flex justify-between items-center px-4 py-3 bg-gray-200 hover:bg-gray-300 focus:outline-none" onclick="this.nextElementSibling.classList.toggle('hidden')">
          <span class="font-semibold">${nombreCliente} <span class='text-xs text-gray-500'>(Pedido #0)</span></span>
          <span class="ml-auto mr-2 total-pill bg-blue-600 text-white font-bold rounded-full px-4 py-1 text-base" style="min-width:120px;text-align:right;"></span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div class="px-4 py-3 bg-white">
          <button class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold" onclick="abrirModalRonda(this)">Crear ronda</button>
          <div class="tabs-rondas flex gap-2 mb-4"></div>
          <div class="contenido-ronda"></div>
          <div class="font-bold text-right mt-4 total-acumulado" style="display:none"></div>
        </div>
      `;
      // Datos de prueba: dos rondas
      acordeon.dataset.rondas = JSON.stringify([
        {
          productos: [
            {nombre: 'Cerveza', cantidad: 2, precio: 3500, subtotal: 7000},
            {nombre: 'Gaseosa', cantidad: 1, precio: 2500, subtotal: 2500}
          ],
          total: 9500,
          responsable: 'Juan'
        },
        {
          productos: [
            {nombre: 'Papas', cantidad: 1, precio: 4000, subtotal: 4000},
            {nombre: 'Agua', cantidad: 2, precio: 2000, subtotal: 4000}
          ],
          total: 8000,
          responsable: 'Pedro'
        }
      ]);
      acordeones.appendChild(acordeon);
      setTimeout(() => renderizarRondas(acordeon), 0);
    }
    // Crear acorde√≥n de prueba al cargar la p√°gina
    window.addEventListener('DOMContentLoaded', crearAcordeonPrueba);
    document.getElementById('btnNuevoPedido').addEventListener('click', function() {
    const nombreCliente = prompt('Ingrese el nombre del cliente para este pedido:');
    if (!nombreCliente) return;
    const acordeones = document.getElementById('acordeonesPedidos');
    const id = pedidoId++;
    const acordeon = document.createElement('div');
    acordeon.className = 'border rounded shadow';
    acordeon.id = `pedido-${id}`;
    acordeon.dataset.id = `pedido-${id}`;
    acordeon.innerHTML = `
      <button type="button" class="w-full flex justify-between items-center px-4 py-3 bg-gray-200 hover:bg-gray-300 focus:outline-none" onclick="this.nextElementSibling.classList.toggle('hidden')">
        <span class="font-semibold">${nombreCliente} <span class='text-xs text-gray-500'>(Pedido #${id})</span></span>
        <span class="ml-auto mr-2 total-pill bg-blue-600 text-white font-bold rounded-full px-4 py-1 text-base" style="min-width:120px;text-align:right;"></span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div class="px-4 py-3 bg-white">
        <button class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold" onclick="abrirModalRonda(this)">Crear ronda</button>
        <div class="tabs-rondas flex gap-2 mb-4"></div>
        <div class="contenido-ronda"></div>
        <div class="font-bold text-right mt-4 total-acumulado" style="display:none"></div>
      </div>
    `;
    acordeon.dataset.rondas = JSON.stringify([]);
    acordeones.appendChild(acordeon);
    setTimeout(() => renderizarRondas(acordeon), 0);
  });
  </script>
</body>
</html>
