<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test M√∫ltiples Pedidos - Barcode Terkkos</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üß™ Test M√∫ltiples Pedidos</h1>
            <h2 class="text-xl text-gray-600">Verificar que no se sobrescriban los pedidos</h2>
        </div>

        <!-- Controls -->
        <div class="flex gap-4 justify-center mb-6">
            <button onclick="initSystem()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                üîß Inicializar Sistema
            </button>
            <button onclick="createTestPedido()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                ‚ûï Crear Pedido de Prueba
            </button>
            <button onclick="showLocalStorage()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                üíæ Ver LocalStorage
            </button>
            <button onclick="clearAll()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                üóëÔ∏è Limpiar Todo
            </button>
        </div>

        <!-- Status -->
        <div id="statusArea" class="bg-white rounded-lg p-6 shadow mb-6">
            <h3 class="font-bold mb-4">üìä Estado del Sistema:</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <div class="font-semibold text-gray-700">Sistema:</div>
                    <div id="systemStatus" class="text-red-600">No inicializado</div>
                </div>
                <div>
                    <div class="font-semibold text-gray-700">Pedidos en Memoria:</div>
                    <div id="pedidosMemoria" class="text-gray-600">0</div>
                </div>
                <div>
                    <div class="font-semibold text-gray-700">Pr√≥ximo ID:</div>
                    <div id="proximoId" class="text-gray-600">-</div>
                </div>
            </div>
        </div>

        <!-- Pedidos List -->
        <div id="pedidosList" class="bg-white rounded-lg p-6 shadow mb-6">
            <h3 class="font-bold mb-4">üìã Pedidos Creados:</h3>
            <div id="pedidosContent" class="text-gray-500">No hay pedidos creados</div>
        </div>

        <!-- Log Area -->
        <div id="logArea" class="bg-black text-green-400 p-4 rounded-lg font-mono text-sm max-h-60 overflow-y-auto">
            <div>Sistema de test iniciado...</div>
        </div>

        <!-- Navigation -->
        <div class="mt-6 text-center">
            <a href="app.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded mr-4">
                üì± Ir al Sistema Principal
            </a>
            <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                üè† Inicio
            </a>
        </div>
    </div>

    <script>
        let app = null;
        let pedidoManager = null;
        let testCounter = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîß';
            logDiv.innerHTML += `<div>[${timestamp}] ${prefix} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus() {
            if (!pedidoManager) return;
            
            document.getElementById('systemStatus').textContent = app ? 'Inicializado ‚úÖ' : 'Error ‚ùå';
            document.getElementById('systemStatus').className = app ? 'text-green-600' : 'text-red-600';
            
            document.getElementById('pedidosMemoria').textContent = pedidoManager.getPedidosCount();
            document.getElementById('proximoId').textContent = pedidoManager.nextPedidoId;
        }

        function updatePedidosList() {
            if (!pedidoManager) return;
            
            const pedidos = pedidoManager.getAllPedidos();
            const content = document.getElementById('pedidosContent');
            
            if (pedidos.length === 0) {
                content.innerHTML = '<div class="text-gray-500">No hay pedidos creados</div>';
                return;
            }

            content.innerHTML = pedidos.map(pedido => `
                <div class="border rounded p-3 mb-2 bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 text-sm">
                        <div><strong>ID:</strong> ${pedido.id}</div>
                        <div><strong>N√∫mero:</strong> ${pedido.numero_pedido}</div>
                        <div><strong>Cliente:</strong> ${pedido.nombre_cliente}</div>
                        <div><strong>Estado:</strong> ${pedido.estado}</div>
                    </div>
                </div>
            `).join('');
        }

        async function initSystem() {
            try {
                log('Inicializando sistema de test...');
                
                // Importar m√≥dulos
                const { DataService } = await import('./frontend/js/services/data-service.js');
                const { ModalManager } = await import('./frontend/js/modules/modal-manager.js');
                const { PedidoManager } = await import('./frontend/js/modules/pedido-manager.js');
                
                log('M√≥dulos importados correctamente');
                
                // Crear instancias
                const dataService = new DataService();
                await dataService.init();
                
                const modalManager = new ModalManager(dataService);
                modalManager.init();
                
                // Crear contenedor temporal para PedidoManager
                if (!document.getElementById('acordeonesPedidos')) {
                    const container = document.createElement('div');
                    container.id = 'acordeonesPedidos';
                    container.style.display = 'none';
                    document.body.appendChild(container);
                }
                
                pedidoManager = new PedidoManager(dataService, modalManager);
                await pedidoManager.init();
                
                app = { dataService, modalManager, pedidoManager };
                
                log('Sistema inicializado correctamente', 'success');
                updateStatus();
                updatePedidosList();
                
            } catch (error) {
                log(`Error inicializando sistema: ${error.message}`, 'error');
                console.error('Error completo:', error);
            }
        }

        async function createTestPedido() {
            if (!pedidoManager) {
                log('Sistema no inicializado', 'error');
                return;
            }
            
            try {
                testCounter++;
                const nombreCliente = `Cliente Test ${testCounter}`;
                
                log(`Creando pedido para: ${nombreCliente}`);
                
                // Obtener estado antes
                const pedidosAntes = pedidoManager.getPedidosCount();
                const proximoIdAntes = pedidoManager.nextPedidoId;
                
                log(`Estado antes - Pedidos: ${pedidosAntes}, Pr√≥ximo ID: ${proximoIdAntes}`);
                
                // Crear pedido usando el m√©todo program√°tico
                const nuevoPedido = await pedidoManager.crearPedido(nombreCliente, null);
                
                if (nuevoPedido) {
                    // Obtener estado despu√©s
                    const pedidosDespues = pedidoManager.getPedidosCount();
                    const proximoIdDespues = pedidoManager.nextPedidoId;
                    
                    log(`Estado despu√©s - Pedidos: ${pedidosDespues}, Pr√≥ximo ID: ${proximoIdDespues}`, 'success');
                    log(`Pedido creado: ${nuevoPedido.id} | ${nuevoPedido.numero_pedido}`, 'success');
                    
                    // Verificar que se agreg√≥ correctamente
                    if (pedidosDespues > pedidosAntes) {
                        log('‚úÖ Pedido agregado correctamente (no sobrescribi√≥)', 'success');
                    } else {
                        log('‚ùå Posible problema: el contador no aument√≥', 'error');
                    }
                    
                    updateStatus();
                    updatePedidosList();
                } else {
                    log('Error: crearPedido retorn√≥ null', 'error');
                }
                
            } catch (error) {
                log(`Error creando pedido: ${error.message}`, 'error');
                console.error('Error completo:', error);
            }
        }

        function showLocalStorage() {
            try {
                const pedidos = localStorage.getItem('barcode_terkkos_pedidos');
                const pedidosData = pedidos ? JSON.parse(pedidos) : [];
                
                log(`LocalStorage contiene ${pedidosData.length} pedidos`);
                pedidosData.forEach((pedido, index) => {
                    log(`  ${index + 1}. ${pedido.id} | ${pedido.numero_pedido} | ${pedido.nombre_cliente}`);
                });
                
            } catch (error) {
                log(`Error leyendo localStorage: ${error.message}`, 'error');
            }
        }

        function clearAll() {
            if (confirm('¬øLimpiar todo el localStorage?')) {
                localStorage.clear();
                testCounter = 0;
                log('LocalStorage limpiado', 'success');
                
                if (pedidoManager) {
                    pedidoManager.pedidos.clear();
                    pedidoManager.nextPedidoId = 1;
                    updateStatus();
                    updatePedidosList();
                }
            }
        }

        // Auto-inicializar
        window.addEventListener('load', () => {
            log('P√°gina cargada. Haz clic en "Inicializar Sistema" para comenzar.');
        });
    </script>
</body>
</html>